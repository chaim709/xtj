# 共识文档：数据迁移工具

## 1. 需求确认

### 1.1 功能需求

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 完整备份导出 | 一键导出所有系统数据 | P0 |
| 数据恢复导入 | 从备份文件恢复数据 | P0 |
| 增量导出 | 只导出指定时间后变更的数据 | P1 |
| 模块化导出 | 可选择性导出特定模块 | P1 |
| JSON格式 | 程序化导入导出格式 | P0 |
| Excel格式 | 人工可读可编辑格式 | P1 |
| 数据库迁移 | 自动处理schema变更 | P0 |
| Web界面 | 可视化导出导入操作 | P2 |

### 1.2 非功能需求

- **性能**：支持10万级题目数据的导出（< 5分钟）
- **可靠性**：导入失败时自动回滚，不影响现有数据
- **兼容性**：支持从v1导入到v2+的版本升级

## 2. 技术实现方案

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据迁移工具                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────────┐   ┌─────────────────────┐               │
│  │   命令行接口 (CLI)   │   │   Web界面 (Routes)   │              │
│  └──────────┬──────────┘   └──────────┬──────────┘               │
│             │                          │                          │
│             └───────────┬──────────────┘                          │
│                         ▼                                         │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │                    迁移服务层                              │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐          │    │
│  │  │ 导出服务    │  │ 导入服务    │  │ 迁移管理    │          │    │
│  │  │ Exporter   │  │ Importer   │  │ Migrator   │          │    │
│  │  └────────────┘  └────────────┘  └────────────┘          │    │
│  └──────────────────────────────────────────────────────────┘    │
│                         │                                         │
│  ┌──────────────────────┴───────────────────────────────────┐    │
│  │                    格式转换层                              │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐          │    │
│  │  │ JSON序列化  │  │ Excel转换   │  │ 版本适配器  │          │    │
│  │  └────────────┘  └────────────┘  └────────────┘          │    │
│  └──────────────────────────────────────────────────────────┘    │
│                         │                                         │
│  ┌──────────────────────┴───────────────────────────────────┐    │
│  │                    数据访问层                              │    │
│  │  ┌─────────────────┐      ┌─────────────────┐            │    │
│  │  │ 题库系统 Models │      │ 督学系统 Models  │            │    │
│  │  └─────────────────┘      └─────────────────┘            │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 导出数据格式

#### JSON格式规范

```json
{
  "meta": {
    "version": "1.0",
    "system": "gongkao-tiku-system",
    "export_time": "2026-01-28T10:00:00Z",
    "export_type": "full|incremental|module",
    "modules": ["questions", "users", "practices"],
    "incremental_since": null,
    "total_records": 12345
  },
  "data": {
    "users": [...],
    "categories": [...],
    "question_books": [...],
    "questions": [...],
    "practices": [...],
    "practice_details": [...],
    "mistakes": [...],
    "weaknesses": [...]
  },
  "relations": {
    "user_question_map": {...},
    "category_hierarchy": {...}
  }
}
```

#### Excel格式规范

每个模块一个Sheet：
- `用户信息` - 用户数据
- `题目分类` - 分类层级
- `题目数据` - 题目详情
- `练习记录` - 学员练习
- `错题本` - 错题记录
- `薄弱项` - 薄弱项分析

### 2.3 数据库迁移管理

使用 **Flask-Migrate**（基于Alembic）：

```
migrations/
├── versions/
│   ├── 001_initial.py
│   ├── 002_add_field.py
│   └── ...
├── alembic.ini
└── env.py
```

## 3. 使用方式

### 3.1 命令行接口

```bash
# 完整备份导出
flask migrate export --format json --output backup.json
flask migrate export --format excel --output backup.xlsx

# 增量导出（指定时间之后的变更）
flask migrate export --format json --since "2026-01-01"

# 模块化导出
flask migrate export --format json --modules questions,users

# 数据导入
flask migrate import --file backup.json

# 数据库schema迁移
flask db upgrade   # 升级到最新版本
flask db downgrade # 回滚上一个版本
```

### 3.2 Web界面

在管理后台提供：
- 备份管理页面
- 导出向导（选择格式、模块、时间范围）
- 导入向导（上传文件、预览、确认）
- 迁移历史记录

## 4. 实现计划

### 阶段一：核心功能（必须）

1. 数据库迁移管理（Flask-Migrate集成）
2. JSON格式完整导出/导入
3. 命令行工具

### 阶段二：增强功能

4. Excel格式导出/导入
5. 增量导出功能
6. 模块化导出功能

### 阶段三：可视化

7. Web界面（管理后台集成）
8. 备份历史管理

## 5. 验收标准

### 5.1 功能验收

- [ ] `flask migrate export --format json` 导出所有数据
- [ ] `flask migrate import --file backup.json` 恢复数据
- [ ] `flask db init/migrate/upgrade` 管理数据库版本
- [ ] 导入时检测并报告数据冲突
- [ ] 导入失败时自动回滚

### 5.2 数据完整性验收

- [ ] 导出后再导入，数据完全一致
- [ ] 外键关系正确恢复
- [ ] 用户密码（加密）正确迁移
- [ ] 时间戳字段正确保留

## 6. 风险与应对

| 风险 | 应对策略 |
|------|----------|
| 数据量过大导致导出超时 | 分批导出，显示进度 |
| 新版本字段变更 | 版本适配器自动转换 |
| 导入冲突（重复数据） | 提供策略选项：跳过/覆盖/报错 |
| 外键约束失败 | 按依赖顺序导入，使用事务 |
