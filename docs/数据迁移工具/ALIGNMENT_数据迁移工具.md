# 对齐文档：数据迁移工具

## 1. 项目上下文分析

### 1.1 现有项目结构

```
公考项目/
├── gongkao-system/          # 督学管理系统
│   ├── app/models/          # 数据模型
│   │   ├── user.py          # 用户模型
│   │   ├── student.py       # 学员模型
│   │   ├── teacher.py       # 教师模型
│   │   ├── course.py        # 课程相关模型
│   │   ├── supervision.py   # 督学日志
│   │   ├── homework.py      # 作业模型
│   │   └── study_plan.py    # 学习计划
│   └── data/                # 数据库文件
│       ├── dev.db           # 开发库
│       └── prod.db          # 生产库
│
├── gongkao-tiku-system/     # 题库系统
│   ├── app/models/          # 数据模型
│   │   ├── user.py          # 用户模型
│   │   ├── question.py      # 题目模型
│   │   ├── category.py      # 分类模型
│   │   ├── practice.py      # 练习模型
│   │   ├── mistake.py       # 错题本模型
│   │   └── knowledge.py     # 知识点模型
│   └── *.db                 # 数据库文件
│
└── gongkao-zhishiku/        # 知识库（纯文档，无需迁移）
```

### 1.2 技术栈

| 组件 | 技术 |
|------|------|
| 后端框架 | Flask 2.3.3 |
| ORM | SQLAlchemy 2.0.21 |
| 数据库 | SQLite |
| 文档处理 | openpyxl, python-docx |

### 1.3 现有导入/导出能力

- **督学系统**：已有Excel导入功能（学员、教师、分类）
- **题库系统**：支持Excel/Word/PDF题目导入
- **缺失功能**：无统一的数据导出机制，无版本迁移管理

## 2. 原始需求

用户希望能够：
1. 在实际使用系统的过程中积累数据
2. 在系统升级到新版本时，能够导出所有数据
3. 在新版本系统中导入之前的数据
4. 支持渐进式升级，不丢失任何用户数据

## 3. 需求理解

### 3.1 核心需求

1. **完整数据备份**：一键导出所有系统数据
2. **数据恢复**：在新版本中导入备份数据
3. **增量导出**：只导出新增/修改的数据
4. **模块化导出**：可选择性导出特定模块的数据
5. **多格式支持**：JSON（程序化）+ Excel（人工可读）
6. **版本兼容**：自动处理新旧版本的数据结构差异

### 3.2 数据迁移范围

#### 题库系统数据（gongkao-tiku-system）

| 数据表 | 优先级 | 说明 |
|--------|--------|------|
| users | 高 | 用户账号信息 |
| categories | 高 | 题目分类体系 |
| question_books | 高 | 题本信息 |
| questions | 高 | 题目数据（核心资产） |
| practice_tasks | 中 | 练习任务 |
| student_submissions | 中 | 学员提交记录 |
| practices | 高 | 在线练习记录 |
| practice_details | 高 | 答题详情 |
| mistakes | 高 | 错题本（学员数据） |
| weaknesses | 高 | 薄弱项分析 |

#### 督学系统数据（gongkao-system）

| 数据表 | 优先级 | 说明 |
|--------|--------|------|
| users | 高 | 管理员账号 |
| students | 高 | 学员信息 |
| teachers | 高 | 教师信息 |
| subjects | 中 | 科目设置 |
| projects | 中 | 项目设置 |
| packages | 中 | 套餐设置 |
| class_types | 中 | 班型设置 |
| batches | 高 | 班次信息 |
| schedules | 中 | 课表信息 |
| supervision_logs | 高 | 督学日志 |
| study_plans | 高 | 学习计划 |
| homework | 中 | 作业记录 |

## 4. 边界确认

### 4.1 范围内

- 两个系统的核心业务数据导出/导入
- JSON和Excel双格式支持
- 数据库版本迁移管理（Flask-Migrate）
- 完整备份、增量导出、模块化导出
- 命令行工具 + Web界面操作

### 4.2 范围外

- 知识库系统（纯Markdown文件，无需迁移工具）
- 系统配置文件的迁移（如.env）
- 上传的文件附件迁移（需单独处理）

## 5. 技术约束

1. **兼容现有架构**：使用Flask命令扩展，无需修改现有代码结构
2. **依赖最小化**：尽量使用已有的依赖库
3. **向后兼容**：导出格式需要包含版本信息，便于未来处理版本差异

## 6. 验收标准

1. 能够一键导出所有数据到JSON/Excel文件
2. 能够从导出文件恢复所有数据到新数据库
3. 支持增量导出（基于时间戳）
4. 支持选择性导出特定模块
5. 数据库schema变更时能够自动生成迁移脚本
6. 提供Web界面进行导出/导入操作
7. 导入时自动检测并处理数据冲突
