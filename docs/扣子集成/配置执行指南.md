# Cloudflare Tunnel 配置执行指南

使用二级域名 `gongkao.chaim.top` 配置内网穿透，连接扣子智能体。

---

## 第一部分：安装 cloudflared

### 步骤 1.1：安装

打开终端，执行：

```bash
brew install cloudflared
```

### 步骤 1.2：验证安装

```bash
cloudflared --version
```

预期输出类似：`cloudflared version 2024.x.x`

---

## 第二部分：登录 Cloudflare

### 步骤 2.1：执行登录命令

```bash
cloudflared tunnel login
```

### 步骤 2.2：浏览器授权

1. 命令会自动打开浏览器
2. 登录您的 Cloudflare 账号
3. 选择域名 **chaim.top**
4. 点击 **授权**

### 步骤 2.3：确认授权成功

终端会显示：

```
You have successfully logged in.
If you wish to copy your credentials to a server, they have been saved to:
/Users/chaim/.cloudflared/cert.pem
```

---

## 第三部分：创建 Tunnel

### 步骤 3.1：创建 tunnel

```bash
cloudflared tunnel create gongkao
```

### 步骤 3.2：记录 Tunnel ID

成功后会显示类似：

```
Created tunnel gongkao with id a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

**请复制并保存这个 ID**，后面需要用到。

### 步骤 3.3：查看凭证文件

```bash
ls ~/.cloudflared/
```

您会看到一个以 Tunnel ID 命名的 `.json` 文件，例如：
`a1b2c3d4-e5f6-7890-abcd-ef1234567890.json`

---

## 第四部分：配置 DNS（创建二级域名）

### 步骤 4.1：添加 DNS 路由

```bash
cloudflared tunnel route dns gongkao gongkao.chaim.top
```

这会在 Cloudflare DNS 中自动创建一条 CNAME 记录，将 `gongkao.chaim.top` 指向您的 tunnel。

### 步骤 4.2：验证 DNS 记录

1. 登录 [Cloudflare 控制台](https://dash.cloudflare.com)
2. 选择域名 `chaim.top`
3. 进入 **DNS** → **记录**
4. 确认存在以下记录：

| 类型 | 名称 | 内容 | 代理状态 |
|------|------|------|----------|
| CNAME | gongkao | xxxxxx.cfargotunnel.com | 已代理 |

---

## 第五部分：创建配置文件

### 步骤 5.1：创建配置文件

```bash
nano ~/.cloudflared/config.yml
```

### 步骤 5.2：粘贴以下内容

**注意：请将 `YOUR_TUNNEL_ID` 替换为步骤 3.2 中获取的实际 ID**

```yaml
# Cloudflare Tunnel 配置文件
# 公考培训学生管理系统

tunnel: gongkao
credentials-file: /Users/chaim/.cloudflared/YOUR_TUNNEL_ID.json

ingress:
  # 学生管理系统 API
  - hostname: gongkao.chaim.top
    service: http://localhost:5001
  
  # 默认规则（必须保留）
  - service: http_status:404
```

### 步骤 5.3：保存并退出

按 `Ctrl+O` 保存，`Enter` 确认，`Ctrl+X` 退出。

### 步骤 5.4：验证配置文件

```bash
cat ~/.cloudflared/config.yml
```

确认内容正确，特别是 `credentials-file` 路径中的 Tunnel ID。

---

## 第六部分：启动服务

### 步骤 6.1：启动 Flask 应用

打开一个新的终端窗口：

```bash
cd /Users/chaim/CodeBuddy/公考项目/gongkao-system
source venv/bin/activate
flask run --port=5001
```

保持这个终端运行。

### 步骤 6.2：启动 Cloudflare Tunnel

打开另一个新的终端窗口：

```bash
cloudflared tunnel run gongkao
```

成功启动后会显示：

```
INF Starting tunnel tunnelID=a1b2c3d4-e5f6-7890-abcd-ef1234567890
INF Connection registered connIndex=0
INF Connection registered connIndex=1
INF Connection registered connIndex=2
INF Connection registered connIndex=3
```

---

## 第七部分：验证连接

### 步骤 7.1：测试 API 访问

打开第三个终端窗口，执行：

```bash
curl -s https://gongkao.chaim.top/api/v1/students \
  -H "X-API-Key: gongkao-api-key-2026-dev-only" | head -100
```

预期返回 JSON 格式的学员列表。

### 步骤 7.2：测试搜索接口

```bash
curl -s "https://gongkao.chaim.top/api/v1/students/search?query=张" \
  -H "X-API-Key: gongkao-api-key-2026-dev-only"
```

### 步骤 7.3：测试创建督学记录

```bash
curl -s -X POST https://gongkao.chaim.top/api/v1/supervision/logs \
  -H "X-API-Key: gongkao-api-key-2026-dev-only" \
  -H "Content-Type: application/json" \
  -d '{"student_name": "测试学员", "content": "今天状态不错，完成了行测练习", "mood": "积极", "study_status": "良好"}'
```

---

## 第八部分：配置后台运行（推荐）

### 方案 A：使用 tmux（推荐）

```bash
# 安装 tmux（如果没有）
brew install tmux

# 创建会话运行 Flask
tmux new -s flask
cd /Users/chaim/CodeBuddy/公考项目/gongkao-system
source venv/bin/activate
flask run --port=5001
# 按 Ctrl+B 然后按 D 退出（保持运行）

# 创建会话运行 Tunnel
tmux new -s tunnel
cloudflared tunnel run gongkao
# 按 Ctrl+B 然后按 D 退出（保持运行）

# 查看会话
tmux ls

# 重新进入会话
tmux attach -t flask
tmux attach -t tunnel
```

### 方案 B：配置开机自启

```bash
# 安装为系统服务
sudo cloudflared service install

# 启动服务
sudo cloudflared service start

# 查看状态
sudo cloudflared service status
```

---

## 第九部分：更新项目配置

### 步骤 9.1：更新 .env 文件

配置文件已更新，确认内容：

```bash
cat /Users/chaim/CodeBuddy/公考项目/gongkao-system/.env
```

确保 `COZE_API_BASE_URL` 为：

```
COZE_API_BASE_URL=https://gongkao.chaim.top
```

---

## 第十部分：配置扣子平台

### 步骤 10.1：登录扣子平台

1. 访问 [coze.cn](https://www.coze.cn)（国内版）或 [coze.com](https://www.coze.com)（国际版）
2. 使用手机号或其他方式登录

### 步骤 10.2：创建自定义插件

1. 进入 **工作空间** → **插件**
2. 点击 **创建插件**
3. 选择 **通过 OpenAPI 导入**
4. 上传文件：`/Users/chaim/CodeBuddy/公考项目/docs/扣子集成/openapi-spec.yaml`
5. 确认导入

### 步骤 10.3：配置插件认证

1. 在插件设置中找到 **鉴权配置**
2. 选择 **API Key**
3. 配置：
   - Header 名称：`X-API-Key`
   - API Key 值：`gongkao-api-key-2026-dev-only`

### 步骤 10.4：测试插件

1. 点击每个接口旁的 **测试** 按钮
2. 填入测试参数
3. 确认返回正常数据

### 步骤 10.5：创建智能体 Bot

1. 返回工作空间，点击 **创建 Bot**
2. 名称：`智能督学助手`
3. 头像：选择一个教育相关的图标
4. 描述：`公考培训智能督学助手，支持语音记录学员情况`

### 步骤 10.6：配置 Bot 人设

在 **人设与回复逻辑** 中粘贴：

```
# 角色定义
你是一位专业的公考培训督学助手，负责协助督学老师管理学员学习情况。

# 核心能力
1. 记录督学日志：接收老师的语音或文字描述，为学员创建督学记录
2. 查询学员信息：根据姓名查找学员及其学习历史
3. 推送作业：将作业任务推送给指定班次的学员
4. 查看待办：提醒需要跟进的学员和待处理事项
5. 生成报告：汇总本周督学工作

# 交互规则
- 使用简洁专业的语言
- 从老师描述中自动识别：学员姓名、学习状态、情绪状态
- 确认关键信息后再执行操作
- 操作成功后给出简短确认

# 情绪识别关键词
积极：开心、认真、努力、进步、积极、主动
一般：正常、还行、一般、平稳
消极：焦虑、烦躁、疲惫、压力大、消极、沮丧

# 学习状态识别
优秀：完成所有任务、超额完成、表现突出
良好：按时完成、正常进度
一般：部分完成、需要督促
较差：未完成、进度落后、需要重点关注
```

### 步骤 10.7：添加技能（插件）

1. 在 **技能** 区域点击 **添加**
2. 选择刚创建的 **公考督学API** 插件
3. 勾选所有接口

### 步骤 10.8：发布 Bot

1. 点击右上角 **发布**
2. 选择发布渠道：
   - **扣子 App**（手机端使用）
   - **网页链接**（可选）
3. 确认发布

---

## 第十一部分：手机端使用

### 步骤 11.1：下载扣子 App

- iOS：App Store 搜索「扣子」
- Android：应用商店搜索「扣子」或在 coze.cn 下载

### 步骤 11.2：登录并找到 Bot

1. 使用与网页端相同的账号登录
2. 在「我的」或「工作空间」中找到「智能督学助手」

### 步骤 11.3：开始使用

语音输入示例：
- "帮我记录一下，张三今天状态很积极，完成了行测专项练习"
- "查一下李四的学习情况"
- "看看有哪些学员需要跟进"
- "把这周的申论作业推送给A班"

---

## 常见问题

### Q1: curl 返回 502 错误

**原因**: Flask 应用未启动或端口不对

**解决**:
```bash
# 确认 Flask 正在运行
curl http://localhost:5001/api/v1/students -H "X-API-Key: gongkao-api-key-2026-dev-only"
```

### Q2: DNS 解析失败

**原因**: DNS 记录未生效

**解决**:
```bash
# 检查 DNS
dig gongkao.chaim.top

# 等待几分钟后重试
```

### Q3: API 返回 401 Unauthorized

**原因**: API Key 不正确

**解决**: 确认请求头中的 `X-API-Key` 值与 `.env` 文件中一致

### Q4: 扣子插件测试失败

**原因**: 网络不通或配置错误

**解决**:
1. 确认 tunnel 正在运行
2. 确认 Flask 正在运行
3. 用 curl 从本地测试确认 API 可访问
4. 检查扣子插件中的 URL 是否正确

---

## 快速命令参考

```bash
# 启动 Flask
cd /Users/chaim/CodeBuddy/公考项目/gongkao-system && source venv/bin/activate && flask run --port=5001

# 启动 Tunnel
cloudflared tunnel run gongkao

# 查看 Tunnel 状态
cloudflared tunnel info gongkao

# 测试 API
curl https://gongkao.chaim.top/api/v1/students -H "X-API-Key: gongkao-api-key-2026-dev-only"

# 查看 Tunnel 列表
cloudflared tunnel list

# 删除 Tunnel（如需重建）
cloudflared tunnel delete gongkao
```

---

## 最终架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      督学老师手机                            │
│                    (扣子 App)                               │
│                        │                                    │
│                    语音/文字输入                             │
│                        ↓                                    │
│              ┌─────────────────┐                           │
│              │  智能督学助手    │                           │
│              │   (扣子 Bot)    │                           │
│              └────────┬────────┘                           │
│                       │                                     │
│                 HTTPS 请求                                  │
│                       ↓                                     │
└───────────────────────┼─────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│              gongkao.chaim.top                              │
│            (Cloudflare CDN + WAF)                           │
└───────────────────────┼─────────────────────────────────────┘
                        │
                        ↓
            ┌───────────────────────┐
            │   Cloudflare Tunnel   │
            │     (加密隧道)         │
            └───────────┬───────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                    您的 Mac                                  │
│                                                             │
│   ┌─────────────────┐      ┌─────────────────────────────┐ │
│   │   cloudflared   │ ───→ │  Flask App (localhost:5001) │ │
│   │   (tunnel 客户端)│      └──────────────┬──────────────┘ │
│   └─────────────────┘                      │                │
│                                            ↓                │
│                              ┌─────────────────────────────┐│
│                              │   SQLite 数据库              ││
│                              │   (学员、督学记录、作业)      ││
│                              └─────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

---

更新日期: 2026-01-28
