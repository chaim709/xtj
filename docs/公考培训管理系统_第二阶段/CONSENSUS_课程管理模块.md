# 第二阶段 Consensus 文档 - 课程管理模块

## 文档信息

| 项目 | 内容 |
|------|------|
| **任务名称** | 第二阶段 - 课程管理模块开发 |
| **阶段** | Align（对齐阶段）- 最终共识 |
| **创建日期** | 2026-01-27 |
| **状态** | ✅ 已确认 |

---

## 1. 明确的需求描述

### 1.1 项目概述

在公考培训管理系统第一阶段基础上，新增**课程管理模块**，实现：
- 完整的课程体系管理（招生项目→班型→班次→课表）
- 老师资源管理
- 学员与课程的深度关联
- 现有模块的整合升级

### 1.2 功能清单

#### P0 核心功能（必须完成）

| 编号 | 功能 | 说明 |
|------|------|------|
| F01 | 科目管理 | 预设科目+自定义科目CRUD |
| F02 | 招生项目管理 | 项目CRUD、状态管理 |
| F03 | 报名套餐管理 | 套餐CRUD、价格、优惠规则 |
| F04 | 班型管理 | 班型CRUD、顺序排列 |
| F05 | 班次管理 | 班次CRUD、日期、人数上限 |
| F06 | 课表管理 | 逐天添加、批量生成、Excel导入、模板复制 |
| F07 | 老师管理 | 老师信息CRUD、排课、冲突检测 |
| F08 | 变更记录 | 换老师/调课自动记录历史 |

#### P1 整合功能（必须完成）

| 编号 | 功能 | 说明 |
|------|------|------|
| F09 | 学员模块改造 | 报名套餐选择、班次分配、进度显示 |
| F10 | 督学模块改造 | 督学日志显示课程进度 |
| F11 | 作业模块改造 | 按班次/科目布置作业 |
| F12 | 工作台升级 | 课程统计、今日课表 |

#### P1 扩展功能（尽量完成）

| 编号 | 功能 | 说明 |
|------|------|------|
| F13 | 考勤管理 | 签到记录、缺课记录 |

---

## 2. 技术实现方案

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    表现层 (Templates)                    │
│  courses/: projects, packages, types, batches, schedules │
│  改造: students, supervision, homework, dashboard        │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                    路由层 (Routes)                        │
│  courses.py (新增)                                       │
│  students.py, supervision.py, homework.py (改造)         │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                    服务层 (Services)                      │
│  course_service.py (新增)                                │
│  teacher_service.py (新增)                               │
│  schedule_service.py (新增)                              │
│  student_service.py (改造)                               │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                    模型层 (Models)                        │
│  course.py (新增): Subject, Project, Package, ClassType, │
│                    ClassBatch, Schedule, ChangeLog       │
│  teacher.py (新增): Teacher                              │
│  student.py (改造): 新增字段                              │
│  student_batch.py (新增): StudentBatch                   │
│  attendance.py (新增): Attendance                        │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                    数据库层 (Database)                    │
│  SQLite (开发) / PostgreSQL (生产)                       │
└─────────────────────────────────────────────────────────┘
```

### 2.2 新增文件清单

```
app/
├── models/
│   ├── course.py        # 课程相关模型（新增）
│   ├── teacher.py       # 老师模型（新增）
│   ├── attendance.py    # 考勤模型（新增）
│   └── student.py       # 学员模型（改造）
├── routes/
│   └── courses.py       # 课程路由（新增）
├── services/
│   ├── course_service.py    # 课程服务（新增）
│   ├── teacher_service.py   # 老师服务（新增）
│   └── schedule_service.py  # 课表服务（新增）
└── templates/
    └── courses/         # 课程模板（新增）
        ├── subjects/
        ├── projects/
        ├── packages/
        ├── types/
        ├── batches/
        ├── schedules/
        └── teachers/
```

### 2.3 数据库设计

**新增表（9张）**:
1. `subjects` - 科目表
2. `projects` - 招生项目表
3. `packages` - 报名套餐表
4. `class_types` - 班型表
5. `class_batches` - 班次表
6. `teachers` - 老师表
7. `schedules` - 课表表
8. `schedule_change_logs` - 变更记录表
9. `student_batches` - 学员班次关联表
10. `attendances` - 考勤表

**改造表（3张）**:
1. `students` - 新增5个字段
2. `supervision_logs` - 新增3个字段
3. `homework_tasks` - 新增3个字段

---

## 3. 技术约束

### 3.1 必须遵守的规范

| 规范 | 说明 |
|------|------|
| 架构模式 | 沿用 Routes → Services → Models 分层 |
| 蓝图命名 | `courses_bp`，URL前缀 `/courses` |
| 模板位置 | `templates/courses/` |
| UI组件 | 使用现有设计系统（Lucide Icons、Bootstrap 5） |
| 数据库 | SQLAlchemy ORM，支持SQLite/PostgreSQL |

### 3.2 API设计规范

| 操作 | HTTP方法 | URL模式 |
|------|---------|---------|
| 列表 | GET | `/courses/xxx` |
| 详情 | GET | `/courses/xxx/{id}` |
| 新增页 | GET | `/courses/xxx/create` |
| 新增 | POST | `/courses/xxx/create` |
| 编辑页 | GET | `/courses/xxx/{id}/edit` |
| 编辑 | POST | `/courses/xxx/{id}/edit` |
| 删除 | POST | `/courses/xxx/{id}/delete` |

### 3.3 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 模型类 | PascalCase | `ClassBatch` |
| 表名 | snake_case复数 | `class_batches` |
| 路由函数 | snake_case | `batch_list` |
| 服务方法 | snake_case | `get_batch_by_id` |
| 模板文件 | snake_case | `batch_list.html` |

---

## 4. 任务边界

### 4.1 明确包含

- ✅ 课程体系完整CRUD
- ✅ 课表4种创建方式（逐天/批量/导入/复制）
- ✅ 老师管理+排课+冲突检测
- ✅ 变更记录自动保存
- ✅ 学员报名流程改造
- ✅ 学员详情显示课程进度
- ✅ 督学日志显示课程信息
- ✅ 作业按班次布置
- ✅ 工作台显示今日课表
- ✅ 基础考勤功能

### 4.2 明确不包含

- ❌ 财务管理（收款、账单）
- ❌ 高级数据报表
- ❌ 微信通知推送
- ❌ 打卡机硬件集成
- ❌ 学员端小程序

### 4.3 边界情况处理

| 场景 | 处理方式 |
|------|---------|
| 旧学员无套餐 | 保留class_name字段，新旧兼容 |
| 删除有学员的班次 | 禁止删除，提示先移除学员 |
| 删除有课表的班次 | 提示确认，级联删除课表 |
| 老师时间冲突 | 排课时警告，允许强制保存 |
| 套餐下架 | 已报名学员不受影响 |

---

## 5. 验收标准

### 5.1 功能验收清单

#### 科目管理
- [ ] 系统预设国省考+事业编常用科目
- [ ] 支持添加自定义科目
- [ ] 支持启用/停用科目
- [ ] 预设科目不可删除

#### 招生项目管理
- [ ] 创建招生项目（名称、考试类型、年份）
- [ ] 设置项目日期范围
- [ ] 查看项目下的套餐和班型
- [ ] 结束/重新开放项目

#### 报名套餐管理
- [ ] 创建多种套餐类型（全程班/期限班/单班型）
- [ ] 设置套餐价格
- [ ] 配置优惠规则（团报、早鸟）
- [ ] 上架/下架套餐

#### 班型管理
- [ ] 创建班型（基础班、提高班等）
- [ ] 设置班型顺序
- [ ] 设置班型单独售价

#### 班次管理
- [ ] 创建班次（设置日期、人数）
- [ ] 查看班次报名学员
- [ ] 更改班次状态（招生中/已开课/已结课）
- [ ] 复制班次创建新班次

#### 课表管理
- [ ] 逐天添加课表
- [ ] 批量生成课表（设置科目+天数）
- [ ] Excel导入课表
- [ ] 从模板复制课表
- [ ] 日历视图展示
- [ ] 导出课表（Excel/打印）

#### 老师管理
- [ ] 添加老师信息（含薪资）
- [ ] 查看老师排课日程
- [ ] 排课时检测时间冲突
- [ ] 查看老师工作量统计

#### 变更记录
- [ ] 换老师自动记录
- [ ] 调课自动记录
- [ ] 按班次/老师查询变更历史

#### 学员模块改造
- [ ] 新增学员时选择报名套餐
- [ ] 为学员分配具体班次
- [ ] 学员详情显示课程信息
- [ ] 学员详情显示学习进度
- [ ] 学员列表支持按班次筛选

#### 督学模块改造
- [ ] 督学日志显示学员当前班次
- [ ] 督学日志显示学习进度

#### 作业模块改造
- [ ] 发布作业时可选择目标班次
- [ ] 作业可关联科目

#### 工作台升级
- [ ] 显示今日课程安排
- [ ] 显示课程相关统计
- [ ] 新增课程相关快捷入口

#### 考勤管理
- [ ] 记录学员签到
- [ ] 记录缺课情况
- [ ] 查看考勤统计

### 5.2 非功能验收

| 指标 | 标准 |
|------|------|
| 页面加载 | < 2秒 |
| 批量生成课表 | < 5秒 |
| Excel导入100行 | < 10秒 |
| 现有功能 | 100%正常 |
| 现有数据 | 完整保留 |

---

## 6. 确认签署

### 6.1 需求确认

- [x] 功能需求已明确
- [x] 技术方案已确定
- [x] 边界条件已定义
- [x] 验收标准已制定

### 6.2 关键假设

1. 系统使用者主要为培训机构内部人员
2. 课程体系管理仅管理员可操作
3. 老师为外聘人员，薪资按日/课时计算
4. 暂不考虑多校区场景

### 6.3 风险识别

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 数据迁移复杂 | 中 | 保留旧字段，渐进迁移 |
| 课表逻辑复杂 | 中 | 充分测试批量生成 |
| 模块耦合 | 低 | 通过服务层解耦 |

---

## 7. 总结

### 7.1 共识达成

**第二阶段开发范围**：
- 新增9张数据表
- 新增1个蓝图（courses）
- 新增12+个页面
- 改造3个现有模块
- 预计6周完成

**核心交付物**：
1. 完整的课程体系管理功能
2. 老师资源管理功能
3. 与现有系统深度整合
4. 完整测试覆盖

### 7.2 下一步

进入 **Architect（架构）** 阶段：
- 输出系统架构图
- 详细模块设计
- API接口规范
- 数据流图

---

**共识状态**: ✅ 已确认  
**确认日期**: 2026-01-27  
**下一阶段**: Architect（架构设计）
