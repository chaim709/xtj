# 第二阶段 Alignment 文档 - 课程管理模块

## 文档信息

| 项目 | 内容 |
|------|------|
| **任务名称** | 第二阶段 - 课程管理模块开发 |
| **阶段** | Align（对齐阶段） |
| **创建日期** | 2026-01-27 |
| **状态** | ✅ 已完成 |

---

## 1. 项目上下文分析

### 1.1 现有项目结构

```
/Users/chaim/CodeBuddy/公考项目/gongkao-system/
├── app/
│   ├── __init__.py          # Flask应用初始化
│   ├── models/              # 数据模型
│   │   ├── user.py          # 用户模型
│   │   ├── student.py       # 学员模型
│   │   ├── supervision.py   # 督学日志模型
│   │   ├── homework.py      # 作业模型
│   │   └── tag.py           # 标签模型
│   ├── routes/              # 路由蓝图
│   │   ├── auth.py          # 认证路由
│   │   ├── dashboard.py     # 工作台路由
│   │   ├── students.py      # 学员路由
│   │   ├── supervision.py   # 督学路由
│   │   └── homework.py      # 作业路由
│   ├── services/            # 业务服务
│   │   ├── student_service.py
│   │   ├── supervision_service.py
│   │   ├── homework_service.py
│   │   ├── tag_service.py
│   │   └── follow_up_service.py
│   ├── templates/           # 模板文件
│   └── static/              # 静态资源
├── config.py                # 配置文件
├── data/                    # SQLite数据库
└── requirements.txt         # 依赖
```

### 1.2 技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| **后端框架** | Flask | 2.3+ |
| **ORM** | SQLAlchemy | 2.0.21+ |
| **数据库** | SQLite（开发）/ PostgreSQL（生产） | - |
| **认证** | Flask-Login | 0.6.3 |
| **前端** | Bootstrap 5 + jQuery + Lucide Icons | - |
| **图表** | Chart.js | 4.4.1 |

### 1.3 现有数据模型

```python
# 已有模型
- User          # 用户（督学人员）
- Student       # 学员
- WeaknessTag   # 薄弱项标签
- SupervisionLog # 督学日志
- HomeworkTask  # 作业任务
- HomeworkSubmission # 作业提交
```

### 1.4 架构模式

- **分层架构**：Routes → Services → Models → Database
- **蓝图模式**：每个功能模块一个Blueprint
- **服务层**：业务逻辑封装在Service类中

---

## 2. 原始需求

### 2.1 用户访谈记录

**访谈日期**: 2026-01-27

**核心需求**:
1. 建立完整的课程体系管理（招生项目→班型→班次→课表）
2. 老师资源管理（信息、排课、薪资、变更记录）
3. 学员与课程深度关联（报名、班次、进度追踪）
4. 现有模块整合升级

**业务规则**:
- 课程层级：招生项目 → 报名套餐 → 班型 → 班次 → 课表
- 报名方式：全程班（365天）、期限班、单班型、单科目
- 上课时间固定：9:00-12:00 / 14:30-17:30 / 18:30-21:00（自习）
- 一整天同一科目
- 科目支持预设+自定义
- 老师为外聘，需记录薪资
- 支持换老师、调课，需记录变更历史
- 学员可报多个班型
- 课表支持Excel导入、批量生成、模板复制

### 2.2 需求边界

**包含**:
- ✅ 科目管理
- ✅ 招生项目管理
- ✅ 报名套餐管理（含价格、优惠规则）
- ✅ 班型管理
- ✅ 班次管理
- ✅ 课表管理
- ✅ 老师管理
- ✅ 变更记录
- ✅ 学员模块改造
- ✅ 督学模块改造
- ✅ 作业模块改造
- ✅ 工作台升级
- ✅ 考勤管理（基础版）

**不包含**:
- ❌ 财务管理（第三阶段）
- ❌ 数据看板（第三阶段）
- ❌ 微信小程序（第三阶段）
- ❌ 打卡机集成（第三阶段）

---

## 3. 需求理解

### 3.1 核心业务流程

```
招生季开始
    ↓
创建招生项目（如：2026国省考系统班）
    ↓
设置报名套餐（全程班19800、暑假班等）
    ↓
创建班型体系（基础班→提高班→刷题班→冲刺班）
    ↓
开设班次（基础班一期、二期...）
    ↓
排课表（每天的科目+老师）
    ↓
学员报名（选择套餐→分配班次）
    ↓
上课学习（签到、学习进度）
    ↓
督学跟进（看到课程进度）
    ↓
布置作业（按班次/科目）
```

### 3.2 用户角色

| 角色 | 功能权限 |
|------|---------|
| **管理员** | 全部功能，包括课程体系管理、老师管理 |
| **督学人员** | 查看课程信息、记录督学日志、布置作业 |

### 3.3 数据关系

```
Project (招生项目)
    │
    ├── 1:N → Package (报名套餐)
    │
    └── 1:N → ClassType (班型)
                  │
                  └── 1:N → ClassBatch (班次)
                                │
                                ├── 1:N → Schedule (课表)
                                │              │
                                │              └── N:1 → Teacher (老师)
                                │              └── N:1 → Subject (科目)
                                │
                                └── N:M → Student (学员)
                                            via StudentBatch
```

---

## 4. 疑问澄清

### 4.1 已确认问题

| 问题 | 回答 | 确认状态 |
|------|------|---------|
| 上课时间段是否固定？ | 是，三个固定时段 | ✅ |
| 同一天是否同一科目？ | 是 | ✅ |
| 科目是否支持自定义？ | 是，预设+自定义 | ✅ |
| 学员能否报多个班型？ | 是 | ✅ |
| 课表创建方式？ | 逐天添加/批量生成/Excel导入/模板复制 | ✅ |
| 老师是否外聘？ | 是 | ✅ |
| 是否需要记录变更历史？ | 是 | ✅ |
| 财务是否本阶段做？ | 否，只记录价格 | ✅ |

### 4.2 假设与决策

| 假设 | 决策 | 依据 |
|------|------|------|
| 权限控制 | 课程管理仅管理员可用 | 安全性考虑 |
| 数据迁移 | 保留旧学员的class_name字段 | 兼容性 |
| 科目预设 | 提供国省考+事业编常用科目 | 业务需求 |

---

## 5. 技术约束

### 5.1 必须遵守

1. **架构一致性**：沿用现有分层架构（Routes → Services → Models）
2. **蓝图模式**：新增 `courses` 蓝图管理课程相关路由
3. **UI风格统一**：使用现有设计系统（Lucide Icons、Bootstrap 5）
4. **数据库兼容**：使用SQLAlchemy，支持SQLite和PostgreSQL
5. **向后兼容**：不破坏现有功能和数据

### 5.2 技术选型

| 功能 | 技术方案 |
|------|---------|
| Excel导入 | pandas + openpyxl（已有依赖） |
| 日历视图 | FullCalendar.js 或 自定义实现 |
| JSON存储 | SQLite JSON1扩展 / TEXT字段 |

---

## 6. 验收标准

### 6.1 功能验收

- [ ] 科目管理：预设+自定义CRUD
- [ ] 招生项目：CRUD、状态管理
- [ ] 报名套餐：CRUD、价格、优惠规则
- [ ] 班型管理：CRUD、排序
- [ ] 班次管理：CRUD、日期、人数
- [ ] 课表管理：4种创建方式、编辑、导出
- [ ] 老师管理：CRUD、排课、冲突检测
- [ ] 变更记录：自动记录、查询
- [ ] 学员改造：报名、班次分配、进度显示
- [ ] 督学改造：显示课程信息
- [ ] 作业改造：按班次布置
- [ ] 工作台升级：课程统计

### 6.2 性能验收

- 页面加载 < 2秒
- 批量生成课表 < 5秒
- Excel导入100行 < 10秒

### 6.3 兼容性验收

- 现有数据完整保留
- 现有功能正常使用
- UI风格统一

---

## 7. 总结

### 7.1 项目范围确认

**第二阶段核心目标**：
1. 建立完整的课程体系管理
2. 老师资源管理
3. 与现有模块深度整合

**预计开发周期**：6周

**交付物**：
- 新增9张数据表
- 新增courses蓝图（12+页面）
- 改造3个现有模块
- 完整测试覆盖

### 7.2 下一阶段

进入 **Architect（架构）** 阶段，输出：
- 系统架构图
- 模块设计
- 接口规范
- 数据流图

---

**文档状态**: ✅ 已完成  
**下一步**: 进入Architect阶段
