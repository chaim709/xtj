# è®¢é˜…æ¶ˆæ¯åŠŸèƒ½ - å¿«é€Ÿå¼€å§‹

## åŠŸèƒ½æ¦‚è§ˆ

âœ… **å·²å®ŒæˆåŠŸèƒ½**

1. **åç«¯API**
   - `/api/v1/wx/send-subscribe` - å‘é€è®¢é˜…æ¶ˆæ¯
   - `/api/v1/wx/subscribe-templates` - è·å–æ¨¡æ¿åˆ—è¡¨

2. **å°ç¨‹åºç«¯**
   - æˆ‘çš„é¡µé¢ â†’ æ¶ˆæ¯æé†’è®¾ç½®
   - è®¢é˜…æˆæƒæµç¨‹
   - è®¢é˜…ç»“æœåé¦ˆ

3. **ç®¡ç†å·¥å…·**
   - `add_subscribe_templates.py` - æ¨¡æ¿ç®¡ç†è„šæœ¬
   - `test_subscribe_message.py` - æµ‹è¯•è„šæœ¬

4. **æ–‡æ¡£**
   - å®Œæ•´çš„é…ç½®æŒ‡å—
   - ä¸šåŠ¡é›†æˆç¤ºä¾‹

## å¿«é€Ÿéƒ¨ç½²ï¼ˆ5åˆ†é’Ÿä¸Šæ‰‹ï¼‰

### ç¬¬1æ­¥ï¼šæ·»åŠ é»˜è®¤æ¨¡æ¿

```bash
cd gongkao-system

# æ·»åŠ é»˜è®¤æ¨¡æ¿åˆ°æ•°æ®åº“
python3 add_subscribe_templates.py

# æŸ¥çœ‹å·²æ·»åŠ çš„æ¨¡æ¿
python3 add_subscribe_templates.py -l
```

### ç¬¬2æ­¥ï¼šåœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·æ¨¡æ¿

1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥ `åŠŸèƒ½` â†’ `è®¢é˜…æ¶ˆæ¯`
3. é€‰æ‹©ä»¥ä¸‹æ¨¡æ¿ï¼š

   | æ¨¡æ¿ç”¨é€” | æ¨èå…³é”®è¯ |
   |---------|-----------|
   | è¯¾ç¨‹æé†’ | è¯¾ç¨‹åç§°ã€ä¸Šè¯¾æ—¶é—´ã€ä¸Šè¯¾åœ°ç‚¹ã€æ¸©é¦¨æç¤º |
   | ä½œä¸šæé†’ | ä½œä¸šåç§°ã€æˆªæ­¢æ—¶é—´ã€ä½œä¸šè¦æ±‚ã€æ¸©é¦¨æç¤º |
   | ç£å­¦æé†’ | ç£å­¦è€å¸ˆã€ç£å­¦æ—¶é—´ã€ç£å­¦å†…å®¹ã€æ¸©é¦¨æç¤º |
   | å­¦ä¹ è®¡åˆ’ | å­¦ä¹ å†…å®¹ã€å®Œæˆè¿›åº¦ã€å­¦ä¹ æ—¶é•¿ã€æ¸©é¦¨æç¤º |

4. è®°å½•æ¯ä¸ªæ¨¡æ¿çš„ID

### ç¬¬3æ­¥ï¼šé…ç½®æ¨¡æ¿ID

ä½¿ç”¨äº¤äº’å¼å·¥å…·æ›´æ–°æ¨¡æ¿IDï¼š

```bash
python3 add_subscribe_templates.py -i

# é€‰æ‹© "4. æ›´æ–°æ¨¡æ¿ID"
# è¾“å…¥æ¨¡æ¿ç±»å‹ï¼Œå¦‚ï¼šclass_reminder
# è¾“å…¥ä»å¾®ä¿¡å…¬ä¼—å¹³å°è·å–çš„æ¨¡æ¿ID
# é€‰æ‹©å¯ç”¨è¯¥æ¨¡æ¿
```

æˆ–è€…ç›´æ¥åœ¨æ•°æ®åº“ä¸­æ›´æ–°ï¼š

```sql
UPDATE wx_subscribe_templates 
SET template_id = 'ä½ çš„æ¨¡æ¿ID', is_active = 1 
WHERE template_type = 'class_reminder';
```

### ç¬¬4æ­¥ï¼šé…ç½®å¾®ä¿¡å°ç¨‹åºä¿¡æ¯

åœ¨ `gongkao-system/.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
WX_APPID=ä½ çš„å°ç¨‹åºAppID
WX_SECRET=ä½ çš„å°ç¨‹åºAppSecret
```

**ç”Ÿäº§ç¯å¢ƒ**å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š

```bash
export WX_APPID=wx1234567890abcdef
export WX_SECRET=your-secret-key-here
```

### ç¬¬5æ­¥ï¼šæµ‹è¯•è®¢é˜…æ¶ˆæ¯

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python3 test_subscribe_message.py
```

è¯¥è„šæœ¬ä¼šæ¼”ç¤ºï¼š
- âœ… å‘é€è¯¾ç¨‹æé†’
- âœ… å‘é€ä½œä¸šæé†’
- âœ… å‘é€ç£å­¦æé†’
- âœ… å‘é€å­¦ä¹ è®¡åˆ’æé†’
- âœ… æ‰¹é‡å‘é€æ¶ˆæ¯

## åœ¨å°ç¨‹åºä¸­ä½¿ç”¨

### ç”¨æˆ·è®¢é˜…æµç¨‹

1. ç”¨æˆ·æ‰“å¼€å°ç¨‹åº â†’ æˆ‘çš„é¡µé¢
2. ç‚¹å‡» **æ¶ˆæ¯æé†’è®¾ç½®**
3. é€‰æ‹©è¦è®¢é˜…çš„æ¶ˆæ¯ç±»å‹
4. å®Œæˆè®¢é˜…

### å°ç¨‹åºç«¯ä»£ç è¯´æ˜

è®¢é˜…åŠŸèƒ½å·²é›†æˆåˆ° `pages/mine/index.js`ï¼š

```javascript
// å¤„ç†è®¢é˜…
handleSubscribe: function() {
  // 1. è·å–åç«¯é…ç½®çš„æ¨¡æ¿åˆ—è¡¨
  // 2. è°ƒç”¨ wx.requestSubscribeMessage
  // 3. æ˜¾ç¤ºè®¢é˜…ç»“æœ
}
```

ç”¨æˆ·ä½“éªŒï¼š
- âœ… è‡ªåŠ¨è·å–æ¨¡æ¿åˆ—è¡¨
- âœ… å‹å¥½çš„æˆæƒæç¤º
- âœ… æ¸…æ™°çš„ç»“æœåé¦ˆ
- âœ… æ”¯æŒé‡æ–°è®¢é˜…

## ä¸šåŠ¡é›†æˆ

### åœºæ™¯1ï¼šè¯¾ç¨‹åˆ›å»ºæ—¶è‡ªåŠ¨æé†’

```python
from test_subscribe_message import send_subscribe_message

# åœ¨è¯¾ç¨‹åˆ›å»º/æ›´æ–°æ—¶
def notify_students_about_class(course):
    students = get_enrolled_students(course.id)
    
    for student in students:
        message_data = {
            'thing1': {'value': course.name[:20]},
            'time2': {'value': course.start_time.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')},
            'thing3': {'value': 'çº¿ä¸Šç›´æ’­è¯¾'},
            'thing4': {'value': 'è¯·æå‰å‡†å¤‡å¥½å­¦ä¹ èµ„æ–™'}
        }
        
        send_subscribe_message(
            student.id, 
            'class_reminder', 
            message_data
        )
```

### åœºæ™¯2ï¼šä½œä¸šå‘å¸ƒæ—¶æé†’

```python
# åœ¨ä½œä¸šåˆ›å»ºæ—¶
def notify_students_about_homework(homework):
    students = get_class_students(homework.class_id)
    
    for student in students:
        message_data = {
            'thing1': {'value': homework.title[:20]},
            'time2': {'value': homework.deadline.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')},
            'thing3': {'value': homework.description[:20]},
            'thing4': {'value': 'è¯·æŒ‰æ—¶å®Œæˆä½œä¸š'}
        }
        
        send_subscribe_message(
            student.id,
            'homework_reminder',
            message_data
        )
```

### åœºæ™¯3ï¼šå®šæ—¶æé†’ï¼ˆä½¿ç”¨å®šæ—¶ä»»åŠ¡ï¼‰

```python
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

# æ¯å¤©æ—©ä¸Š8ç‚¹æé†’ä»Šå¤©æœ‰è¯¾çš„å­¦å‘˜
@scheduler.scheduled_job('cron', hour=8)
def morning_class_reminder():
    today_courses = get_today_courses()
    
    for course in today_courses:
        notify_students_about_class(course)

scheduler.start()
```

## æ³¨æ„äº‹é¡¹

### 1. è®¢é˜…é™åˆ¶

- âœ… æ¯æ¬¡è®¢é˜…åªèƒ½å‘é€**ä¸€æ¬¡**æ¶ˆæ¯
- âœ… éœ€è¦å¤šæ¬¡æ¨é€ï¼Œéœ€è¦ç”¨æˆ·å¤šæ¬¡æˆæƒ
- âœ… å»ºè®®åœ¨å…³é”®æµç¨‹å¼•å¯¼ç”¨æˆ·è®¢é˜…

### 2. æ¶ˆæ¯å†…å®¹è¦æ±‚

- ğŸ“ `thing` ç±»å‹ï¼šæœ€å¤š20ä¸ªå­—ç¬¦
- ğŸ“… `time` ç±»å‹ï¼šæ ‡å‡†æ—¶é—´æ ¼å¼
- ğŸ’° `amount` ç±»å‹ï¼šé‡‘é¢æ ¼å¼
- ğŸ”¢ `number` ç±»å‹ï¼šæ•°å­—

### 3. å¼€å‘æ¨¡å¼

æœªé…ç½® `WX_APPID` å’Œ `WX_SECRET` æ—¶ï¼š
- åç«¯ä¼šè·³è¿‡å®é™…å‘é€
- è¿”å›æˆåŠŸçŠ¶æ€ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
- æ—¥å¿—ä¼šæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯

### 4. é”™è¯¯å¤„ç†

å¸¸è§é”™è¯¯åŠè§£å†³ï¼š

| é”™è¯¯ç  | è¯´æ˜ | è§£å†³æ–¹æ³• |
|--------|------|---------|
| 43101 | ç”¨æˆ·æ‹’ç»æ¥å—æ¶ˆæ¯ | å¼•å¯¼ç”¨æˆ·é‡æ–°è®¢é˜… |
| 40003 | openidé”™è¯¯ | æ£€æŸ¥å­¦å‘˜ç»‘å®šçŠ¶æ€ |
| 47003 | æ¨¡æ¿å‚æ•°ä¸åŒ¹é… | æ£€æŸ¥æ¶ˆæ¯æ•°æ®æ ¼å¼ |
| 41030 | access_tokenè¿‡æœŸ | è‡ªåŠ¨é‡æ–°è·å– |

## è¿›é˜¶é…ç½®

### è‡ªå®šä¹‰è·³è½¬é¡µé¢

å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šå°ç¨‹åºé¡µé¢ï¼š

```python
send_data = {
    'touser': student.wx_openid,
    'template_id': template.template_id,
    'page': 'pages/courses/detail?id=123',  # è‡ªå®šä¹‰é¡µé¢
    'data': message_data
}
```

### æ¶ˆæ¯ç»Ÿè®¡

å»ºè®®è®°å½•ï¼š
- å‘é€æ¬¡æ•°
- æˆåŠŸç‡
- ç”¨æˆ·ç‚¹å‡»ç‡

å¯ä»¥æ‰©å±• `StudentMessage` æ¨¡å‹æ¥è¿½è¸ªã€‚

### æ€§èƒ½ä¼˜åŒ–

å¯¹äºå¤§é‡æ¶ˆæ¯å‘é€ï¼š
1. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ Celeryï¼‰
2. æ‰¹é‡è·å– access_tokenï¼ˆç¼“å­˜2å°æ—¶ï¼‰
3. å¼‚æ­¥å‘é€ï¼Œä¸é˜»å¡ä¸»æµç¨‹

```python
# ä½¿ç”¨ Celery å¼‚æ­¥å‘é€
@celery.task
def send_subscribe_async(student_id, template_type, data):
    send_subscribe_message(student_id, template_type, data)
```

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `app/routes/wx_api.py` | è®¢é˜…æ¶ˆæ¯API |
| `app/models/message.py` | æ¶ˆæ¯æ¨¡å‹ |
| `pages/mine/index.js` | å°ç¨‹åºè®¢é˜…åŠŸèƒ½ |
| `add_subscribe_templates.py` | æ¨¡æ¿ç®¡ç†å·¥å…· |
| `test_subscribe_message.py` | æµ‹è¯•è„šæœ¬ |
| `è®¢é˜…æ¶ˆæ¯é…ç½®æŒ‡å—.md` | è¯¦ç»†æ–‡æ¡£ |

## ä¸‹ä¸€æ­¥

- [ ] åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·æ¨¡æ¿
- [ ] é…ç½®æ¨¡æ¿ID
- [ ] æµ‹è¯•è®¢é˜…å’Œå‘é€
- [ ] é›†æˆåˆ°ä¸šåŠ¡æµç¨‹
- [ ] ç›‘æ§å‘é€æ•ˆæœ

## æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ
1. æŸ¥çœ‹ `è®¢é˜…æ¶ˆæ¯é…ç½®æŒ‡å—.md`
2. è¿è¡Œ `test_subscribe_message.py` æµ‹è¯•
3. æ£€æŸ¥åç«¯æ—¥å¿—
4. å‚è€ƒå¾®ä¿¡å®˜æ–¹æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æ›´æ–°æ—¶é—´ï¼š** 2026-02-01  
**ç»´æŠ¤è€…ï¼š** å¼€å‘å›¢é˜Ÿ
