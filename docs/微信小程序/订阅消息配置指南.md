# 微信小程序订阅消息配置指南

## 一、什么是订阅消息

订阅消息是微信小程序提供的消息推送能力，用户主动订阅后，小程序可以通过后端API向用户推送重要的服务消息。

### 应用场景
- 上课提醒：提醒学员即将开始的课程
- 作业提醒：提醒学员完成作业任务
- 督学通知：老师的督学消息推送
- 学习进度：学习计划完成提醒

## 二、在微信公众平台申请订阅消息模板

### 1. 登录微信公众平台

访问 [微信公众平台](https://mp.weixin.qq.com/)，使用小程序管理员账号登录。

### 2. 进入订阅消息管理

导航路径：`功能` → `订阅消息`

### 3. 选择模板类别

点击"选用"，在模板库中搜索适合的模板：

#### 推荐模板类别

**课程提醒模板**
- 关键词示例：课程名称、上课时间、上课地点、温馨提示
- 用途：上课前提醒学员

**作业提醒模板**
- 关键词示例：作业名称、截止时间、作业要求、温馨提示
- 用途：提醒学员完成作业

**学习进度通知**
- 关键词示例：学习内容、完成进度、学习时长、温馨提示
- 用途：学习计划完成情况

### 4. 获取模板ID

添加模板后，在"我的模板"列表中可以看到：
- 模板标题
- 模板ID（形如：`ABCDEFGHIJKLMNOPQRSTUVWXYZ123456`）
- 详情（可以查看模板的具体字段）

**记录每个模板的ID和类型，后续配置需要用到。**

## 三、在后端配置订阅消息模板

### 1. 添加模板到数据库

在 `gongkao-system` 目录下创建数据库脚本或使用 Flask Shell：

```python
# 进入 Flask Shell
python3 -c "
from app import create_app, db
from app.models.message import WxSubscribeTemplate

app = create_app('development')
with app.app_context():
    # 添加课程提醒模板
    template1 = WxSubscribeTemplate(
        template_id='你的模板ID1',  # 从微信公众平台获取
        template_type='class_reminder',
        title='课程提醒',
        description='提醒学员即将开始的课程',
        is_active=True
    )
    
    # 添加作业提醒模板
    template2 = WxSubscribeTemplate(
        template_id='你的模板ID2',  # 从微信公众平台获取
        template_type='homework_reminder',
        title='作业提醒',
        description='提醒学员完成作业',
        is_active=True
    )
    
    db.session.add(template1)
    db.session.add(template2)
    db.session.commit()
    print('订阅消息模板配置完成')
"
```

### 2. 配置环境变量

在 `gongkao-system/.env` 文件中配置微信小程序信息：

```bash
# 微信小程序配置
WX_APPID=你的小程序AppID
WX_SECRET=你的小程序AppSecret
```

**注意：生产环境请使用环境变量，不要将敏感信息提交到代码仓库。**

## 四、在小程序中使用订阅消息

### 1. 小程序端已实现功能

- 菜单入口：我的页面 → 消息提醒设置
- 自动获取后端配置的模板列表
- 调用 `wx.requestSubscribeMessage` 请求用户授权
- 显示订阅结果反馈

### 2. 用户订阅流程

1. 用户点击"消息提醒设置"
2. 小程序向后端请求可用的模板列表
3. 调用微信API请求用户授权
4. 用户选择接受或拒绝
5. 返回订阅结果

### 3. 订阅状态说明

- `accept`：用户同意订阅该消息
- `reject`：用户拒绝订阅该消息
- `ban`：用户已被后台封禁，无法订阅

**重要提示：**
- 每次用户点击都只能请求一次授权
- 用户同意后，可发送一次订阅消息
- 如需多次推送，需用户多次授权

## 五、发送订阅消息

### 1. 后端API调用

已实现接口：`POST /api/v1/wx/send-subscribe`

```json
{
  "type": "class_reminder",
  "data": {
    "thing1": {
      "value": "行测基础班"
    },
    "time2": {
      "value": "2026年2月15日 14:00"
    },
    "thing3": {
      "value": "线上直播课"
    },
    "thing4": {
      "value": "请提前5分钟进入直播间"
    }
  }
}
```

### 2. 消息数据格式

根据模板的具体字段填写，常见字段类型：

- `thing{n}`：事物（20个以内字符）
- `time{n}`：时间（格式：2026-02-15 14:00）
- `character_string{n}`：字符串（32个以内字符）
- `number{n}`：数字
- `amount{n}`：金额

**示例：作业提醒**

```json
{
  "type": "homework_reminder",
  "data": {
    "thing1": {
      "value": "第3周作业"
    },
    "time2": {
      "value": "2026年2月20日 23:59"
    },
    "thing3": {
      "value": "完成判断推理题50道"
    },
    "thing4": {
      "value": "请按时提交作业"
    }
  }
}
```

### 3. 集成到业务流程

可以在以下场景自动发送订阅消息：

```python
# 在课程创建时发送提醒
from app.routes.wx_api import send_subscribe_message

# 获取学员
students = CourseAttendance.query.filter_by(course_id=course_id).all()

for attendance in students:
    # 调用订阅消息API
    try:
        send_data = {
            'type': 'class_reminder',
            'data': {
                'thing1': {'value': course.name},
                'time2': {'value': course.start_time.strftime('%Y年%m月%d日 %H:%M')},
                'thing3': {'value': '线上直播课'},
                'thing4': {'value': '请提前准备好学习资料'}
            }
        }
        # 这里需要模拟请求上下文
        # 实际使用时应该通过消息队列异步发送
    except Exception as e:
        logger.error(f'发送订阅消息失败: {e}')
```

## 六、测试订阅消息

### 1. 开发模式测试

后端未配置 `WX_APPID` 和 `WX_SECRET` 时，会跳过实际发送：

```python
if not appid or not secret:
    current_app.logger.warning('微信配置未完成，跳过发送')
    return jsonify({
        'success': True,
        'message': '开发模式，跳过发送'
    })
```

### 2. 正式环境测试

1. 配置好微信小程序的 AppID 和 AppSecret
2. 在数据库中添加模板配置
3. 在小程序中订阅消息
4. 调用后端API发送测试消息
5. 检查微信小程序是否收到订阅消息

### 3. 调试工具

- 微信公众平台：查看发送记录和错误日志
- 小程序开发者工具：查看订阅状态
- 后端日志：查看API调用情况

## 七、常见问题

### 1. 用户收不到订阅消息

**原因：**
- 用户未订阅该模板
- 用户已经收到过一次（每次订阅只能发送一次）
- 模板ID配置错误
- access_token 过期或无效

**解决：**
- 引导用户重新订阅
- 检查模板ID是否正确
- 确保后端配置正确

### 2. 订阅授权弹窗不出现

**原因：**
- 模板ID不存在或未启用
- 小程序版本过低
- 接口调用频率过高

**解决：**
- 检查模板配置
- 更新微信版本
- 控制调用频率

### 3. 返回错误码说明

常见错误码：
- `43101`：用户拒绝接受消息
- `40003`：openid 错误
- `47003`：模板参数不匹配
- `41030`：access_token 过期

参考：[微信官方文档-订阅消息错误码](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)

## 八、最佳实践

### 1. 合理使用订阅消息

- 不要频繁推送
- 内容要有价值
- 时机要合适（如课前1小时提醒）

### 2. 提升订阅率

- 在关键流程引导订阅（如报名成功后）
- 说明订阅的好处
- 提供随时取消订阅的入口

### 3. 数据统计

建议记录：
- 订阅次数
- 发送次数
- 发送成功率
- 用户点击率

### 4. 安全建议

- 不要在代码中硬编码 AppSecret
- 使用环境变量管理敏感信息
- access_token 应该缓存，避免频繁请求
- 做好异常处理和日志记录

## 九、相关资源

- [微信小程序订阅消息官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [订阅消息模板库](https://mp.weixin.qq.com/)
- [后端API文档](../API文档.md)

## 十、更新日志

- 2026-02-01：创建订阅消息配置指南
- 完成后端API开发
- 完成小程序订阅授权功能
