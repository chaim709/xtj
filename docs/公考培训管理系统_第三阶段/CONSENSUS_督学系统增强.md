# 第三阶段 Consensus 文档 - 督学系统增强

## 文档信息

| 项目 | 内容 |
|------|------|
| **任务名称** | 第三阶段 - 督学系统增强 |
| **创建日期** | 2026-01-27 |
| **状态** | ✅ 已达成共识 |

---

## 一、需求共识

### 1.1 确定的功能范围

| 优先级 | 功能模块 | 描述 | 状态 |
|--------|----------|------|------|
| **P0** | 课表日历视图 | 独立页面，月/周视图，点击查看详情 | ✅ 确认 |
| **P0** | 数据分析看板 | 全面统计，ECharts图表，多维度分析 | ✅ 确认 |
| **P1** | API接口开放 | RESTful API，统一配置文件管理Key | ✅ 确认 |
| **P1** | 学员详情增强 | 课程进度、督学汇总、考勤统计 | ✅ 确认 |
| **P1** | 通知提醒 | 待跟进学员提醒（7天未跟进） | ✅ 确认 |

### 1.2 明确排除的功能

| 功能 | 原因 |
|------|------|
| 日历拖拽调整 | 第一版不做，后续迭代 |
| 数据导出(Excel/PDF) | 第一版不做，后续迭代 |
| 题库管理 | 作为独立项目开发 |
| 实时推送通知 | 第一版只做页面内提醒 |

---

## 二、技术共识

### 2.1 前端技术栈

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 日历 | **FullCalendar.js 6.x** | 功能全面，支持月/周/日视图 |
| 图表 | **ECharts 5.x** | Apache开源，功能全面，交互丰富 |
| UI框架 | Bootstrap 5 | 与现有系统一致 |
| 交互 | jQuery 3.7 | 与现有系统一致 |

### 2.2 后端技术栈

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| API框架 | Flask Blueprint | 独立API蓝图 |
| 认证 | API Key + 装饰器 | 统一配置文件管理 |
| 数据聚合 | SQLAlchemy | 使用聚合函数和子查询 |

### 2.3 配置管理

**API Key配置位置**: `.env` 文件

```env
# API配置
API_KEY=your_secure_api_key_here
API_KEY_HEADER=X-API-Key
```

**跟进提醒配置**:

```python
# config.py
FOLLOW_UP_REMINDER_DAYS = 7  # 超过7天未跟进则提醒
```

---

## 三、功能规格确认

### 3.1 课表日历视图

```
┌─────────────────────────────────────────────────────────────────┐
│  课程日历                                          [月视图|周视图]│
├─────────────────────────────────────────────────────────────────┤
│  筛选: [全部班次 ▼] [全部老师 ▼] [全部科目 ▼]                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ◀  2026年1月  ▶                              [今天]             │
│                                                                   │
│  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐                    │
│  │ 周一 │ 周二 │ 周三 │ 周四 │ 周五 │ 周六 │ 周日 │                    │
│  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  │ 27  │ 28  │ 29  │ 30  │ 31  │  1  │  2  │                    │
│  │     │     │     │     │     │     │     │                    │
│  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  │  3  │  4  │  5  │  6  │  7  │  8  │  9  │                    │
│  │ ━━━ │ ━━━ │ ━━━ │ ━━━ │ ━━━ │     │     │                    │
│  │江苏 │江苏 │江苏 │江苏 │江苏 │     │     │                    │
│  └─────┴─────┴─────┴─────┴─────┴─────┴─────┘                    │
│                                                                   │
│  点击日期 → 弹窗显示当日课程详情 → 可跳转至班次详情页              │
└─────────────────────────────────────────────────────────────────┘
```

**交互方式**:
- 点击日期 → 弹出Modal显示当日所有课程
- 弹窗内可点击班次名跳转到班次详情页
- 不支持拖拽调整

### 3.2 数据分析看板

**统计卡片（顶部）**:
| 指标 | 数据源 |
|------|--------|
| 学员总数 | students表 |
| 本月新增 | students.created_at |
| 今日督学 | supervision_logs.created_at |
| 待跟进学员 | 超过7天无督学记录 |

**图表区域**:
| 图表类型 | 展示内容 | 位置 |
|----------|----------|------|
| 折线图 | 学员增长趋势（30天） | 左上 |
| 环形图 | 学员状态分布 | 右上 |
| 柱状图 | 督学工作量排行 | 左下 |
| 横向柱状图 | 薄弱知识点Top10 | 右下 |
| 进度条 | 各班次课程进度 | 底部 |

**筛选功能**:
- 时间范围：最近7天/30天/90天/自定义
- 班次筛选：可选特定班次

### 3.3 API接口规格

**基础路径**: `/api/v1/`

**认证**: 请求头携带 `X-API-Key`

**接口清单**:

| 方法 | 路径 | 功能 | 参数 |
|------|------|------|------|
| GET | `/students` | 学员列表 | page, per_page, status, batch_id |
| GET | `/students/<id>` | 学员详情 | - |
| GET | `/batches` | 班次列表 | status, project_id |
| GET | `/batches/<id>` | 班次详情 | - |
| GET | `/batches/<id>/students` | 班次学员 | - |
| POST | `/students/<id>/weakness` | 更新薄弱项 | tags[] |

**响应格式**:
```json
{
    "success": true,
    "data": { ... },
    "message": "操作成功",
    "pagination": {
        "page": 1,
        "per_page": 20,
        "total": 100,
        "pages": 5
    }
}
```

### 3.4 学员详情增强

**新增信息区块**:

```
┌─────────────────────────────────────────────────────────────────┐
│  张三 - 学员详情                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  【基本信息】（现有）                                              │
│  姓名、电话、报考项目、状态...                                    │
│                                                                   │
│  ─────────────────────────────────────────────────────────────   │
│                                                                   │
│  【课程信息】（新增）                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 报名套餐: 全程班A套餐                                     │    │
│  │ 所属班次: 2026江苏事业编第一期                            │    │
│  │ 课程进度: ████████░░░░ 68% (62/91天)                     │    │
│  │ 入班日期: 2026-01-06                                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  【督学汇总】（新增）                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 督学记录: 23条                                            │    │
│  │ 最近沟通: 2026-01-25 (2天前)                              │    │
│  │ 沟通频率: 平均3.2天/次                                    │    │
│  │ 主要方式: 微信(65%) 电话(35%)                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  【考勤统计】（新增）                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 应出勤: 45天 | 实出勤: 42天 | 出勤率: 93.3%              │    │
│  │ 迟到: 2次 | 请假: 1次 | 缺勤: 0次                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  【薄弱知识点】（现有，优化展示）                                  │
│  ...                                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 3.5 通知提醒

**工作台提醒区域**:

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚠️ 待处理事项                                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  🔔 待跟进学员 (5)                                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ • 张三 - 8天未跟进 [去跟进]                              │    │
│  │ • 李四 - 10天未跟进 [去跟进]                             │    │
│  │ • 王五 - 7天未跟进 [去跟进]                              │    │
│  │ [查看全部...]                                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  📅 今日课程 (3个班次)                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ • 江苏事业编第一期 - Day 22                              │    │
│  │   上午: 言语 | 下午: 判断 | 晚上: 自习                   │    │
│  │ [查看详情]                                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

**提醒规则**:
- 超过7天未有督学记录的学员
- 状态为"在读"的学员优先提醒
- 按未跟进天数倒序排列

---

## 四、验收标准

### 4.1 功能验收清单

| 编号 | 功能 | 验收标准 |
|------|------|----------|
| A1 | 日历月视图 | 正确显示当月所有课程，不同班次用不同颜色 |
| A2 | 日历周视图 | 正确显示一周课程，包含上午/下午/晚上时段 |
| A3 | 日历筛选 | 班次/老师/科目筛选正常工作 |
| A4 | 日历详情弹窗 | 点击日期弹出当日课程详情 |
| B1 | 统计卡片 | 学员总数、新增、督学数、待跟进数正确 |
| B2 | 折线图 | 学员增长趋势数据正确 |
| B3 | 饼图 | 状态分布正确 |
| B4 | 柱状图 | 督学工作量、薄弱项排行正确 |
| C1 | API认证 | 无Key或错误Key返回401 |
| C2 | 学员API | 列表、详情接口正确返回 |
| C3 | 班次API | 列表、详情、学员接口正确返回 |
| D1 | 学员课程信息 | 详情页正确显示课程进度 |
| D2 | 督学汇总 | 详情页正确显示督学统计 |
| D3 | 考勤统计 | 详情页正确显示考勤数据 |
| E1 | 待跟进提醒 | 工作台正确显示超7天未跟进学员 |
| E2 | 今日课程 | 工作台正确显示今日课程 |

### 4.2 非功能验收

| 项目 | 标准 |
|------|------|
| 日历加载速度 | < 2秒 |
| 数据看板加载 | < 3秒 |
| API响应时间 | < 500ms |
| 浏览器兼容 | Chrome/Safari/Edge 最新版 |

---

## 五、任务边界

### 5.1 本阶段交付物

1. **代码交付**
   - 日历视图页面及API
   - 数据分析看板页面及API
   - 开放API接口及认证
   - 学员详情页增强
   - 工作台提醒功能

2. **文档交付**
   - 需求规格文档
   - 技术设计文档
   - API接口文档
   - 测试报告

### 5.2 后续迭代（不在本阶段）

- 日历拖拽调整功能
- 数据导出(Excel/PDF)
- 实时推送通知
- 更复杂的权限管理
- 题库系统（独立项目）

---

## 六、风险与约束

### 6.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| ECharts学习成本 | 中 | 参考官方示例，使用常用图表类型 |
| 数据量大时性能 | 中 | 使用分页、懒加载、适当缓存 |
| API安全 | 中 | API Key认证 + 请求频率限制 |

### 6.2 依赖约束

- 依赖第二阶段数据：课程、班次、考勤数据
- 依赖外部CDN：ECharts、FullCalendar（或本地部署）

---

## 七、确认签署

| 事项 | 确认 |
|------|------|
| 需求范围已确认 | ✅ |
| 技术方案已确认 | ✅ |
| 排除功能已确认 | ✅ |
| 验收标准已确认 | ✅ |

---

**共识达成，准备进入 Architect（架构设计）阶段。**
