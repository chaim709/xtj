{% extends "base.html" %}

{% block title %}工作台 - 公考培训管理系统{% endblock %}

{% block content %}
<!-- 欢迎区 -->
<div class="welcome-card">
    <div class="welcome-text">
        <h2>Welcome, {{ current_user.real_name or current_user.username }}!</h2>
        <p>管理学员进度、记录督学日志，助力学员高效备考</p>
    </div>
    <div class="welcome-actions">
        <button class="btn-icon">
            <i data-lucide="bell" style="width:20px;height:20px;"></i>
        </button>
        <div class="user-avatar">
            <div class="user-avatar-placeholder">
                {{ (current_user.real_name or current_user.username)[0] }}
            </div>
            <div class="user-info">
                <div class="user-name">{{ current_user.real_name or current_user.username }}</div>
                <div class="user-email">{{ current_user.email or '督学老师' }}</div>
            </div>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card" onclick="location.href='{{ url_for('students.list') }}'">
            <div class="stat-card-header">
                <div class="stat-card-title">学员总数</div>
                <div class="stat-card-icon blue">
                    <i data-lucide="users" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ stats.total_students }}</div>
            <div class="stat-card-trend up">
                <i data-lucide="user-check" style="width:14px;height:14px;"></i>
                在读学员
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" onclick="location.href='{{ url_for('students.list') }}?need_attention=1'">
            <div class="stat-card-header">
                <div class="stat-card-title">待跟进</div>
                <div class="stat-card-icon orange">
                    <i data-lucide="clock" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ '%02d' % stats.need_follow_up }}</div>
            <div class="stat-card-trend {% if stats.need_follow_up > 5 %}down{% else %}up{% endif %}">
                <i data-lucide="{% if stats.need_follow_up > 5 %}alert-circle{% else %}check-circle{% endif %}" style="width:14px;height:14px;"></i>
                {% if stats.need_follow_up > 5 %}需及时处理{% else %}情况良好{% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" onclick="location.href='{{ url_for('supervision.my_logs') }}'">
            <div class="stat-card-header">
                <div class="stat-card-title">本周督学</div>
                <div class="stat-card-icon" style="background:#DCFCE7;color:#16A34A;">
                    <i data-lucide="clipboard-check" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ stats.week_logs }}</div>
            <div class="stat-card-trend up">
                <i data-lucide="trending-up" style="width:14px;height:14px;"></i>
                本周记录
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card stat-card-gradient" onclick="location.href='{{ url_for('homework.list') }}'">
            <div class="stat-card-header">
                <div class="stat-card-title">进行中作业</div>
                <div class="stat-card-icon" style="background:rgba(255,255,255,0.2);">
                    <i data-lucide="book-open" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ stats.active_homework or 0 }}</div>
            <div class="stat-card-trend">
                <i data-lucide="file-text" style="width:14px;height:14px;"></i>
                待完成作业
            </div>
        </div>
    </div>
</div>

<!-- 课程统计卡片 -->
{% if course_stats %}
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card" onclick="location.href='{{ url_for('courses.project_list') }}'">
            <div class="stat-card-header">
                <div class="stat-card-title">招生项目</div>
                <div class="stat-card-icon" style="background:#8B5CF6;">
                    <i data-lucide="folder-open" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ course_stats.recruiting_projects }}</div>
            <div class="stat-card-trend up">
                <i data-lucide="trending-up" style="width:14px;height:14px;"></i>
                正在招生
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" onclick="location.href='{{ url_for('courses.batch_list') }}?status=ongoing'">
            <div class="stat-card-header">
                <div class="stat-card-title">进行中班次</div>
                <div class="stat-card-icon green">
                    <i data-lucide="play-circle" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ course_stats.ongoing_batches }}</div>
            <div class="stat-card-trend up">
                <i data-lucide="users" style="width:14px;height:14px;"></i>
                正在上课
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" onclick="location.href='{{ url_for('courses.batch_list') }}?status=recruiting'">
            <div class="stat-card-header">
                <div class="stat-card-title">招生中班次</div>
                <div class="stat-card-icon" style="background:#F97316;">
                    <i data-lucide="megaphone" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ course_stats.recruiting_batches }}</div>
            <div class="stat-card-trend up">
                <i data-lucide="user-plus" style="width:14px;height:14px;"></i>
                可报名
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" onclick="location.href='{{ url_for('courses.teacher_list') }}'">
            <div class="stat-card-header">
                <div class="stat-card-title">在职老师</div>
                <div class="stat-card-icon" style="background:#10B981;">
                    <i data-lucide="user-check" style="width:20px;height:20px;"></i>
                </div>
            </div>
            <div class="stat-card-value">{{ course_stats.active_teachers }}</div>
            <div class="stat-card-trend up">
                <i data-lucide="check-circle" style="width:14px;height:14px;"></i>
                可排课
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row g-4">
    <!-- 左侧：待跟进学员 -->
    <div class="col-lg-8">
        <div class="list-card">
            <div class="list-card-header">
                <div class="list-card-title">
                    <i data-lucide="alert-circle" style="width:18px;height:18px;margin-right:8px;color:#F59E0B;"></i>
                    待跟进学员
                </div>
                <a href="{{ url_for('students.list') }}?need_attention=1" class="list-card-action">
                    查看全部 →
                </a>
            </div>
            
            {% if stats.follow_up_students %}
            {% for student in stats.follow_up_students[:6] %}
            <div class="list-item" onclick="location.href='{{ url_for('students.detail', id=student.id) }}'">
                <div class="list-item-left">
                    <div class="list-item-avatar">{{ student.name[0] }}</div>
                    <div>
                        <div class="list-item-name">{{ student.name }}</div>
                        <div class="list-item-sub">
                            {{ student.class_name or '未分班' }} · 
                            {% if student.last_contact_date %}
                            最后联系: {{ student.last_contact_date.strftime('%m-%d') }}
                            {% else %}
                            从未联系
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if student.need_attention %}
                    <span class="badge" style="background:#FEF3C7;color:#D97706;">重点关注</span>
                    {% endif %}
                    <a href="{{ url_for('supervision.log_form') }}?student_id={{ student.id }}" 
                       class="btn btn-sm btn-primary" style="border-radius:8px;" 
                       onclick="event.stopPropagation();">
                        记录督学
                    </a>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-5 text-muted">
                <i data-lucide="check-circle" style="width:48px;height:48px;color:#10B981;opacity:0.5;"></i>
                <p class="mt-3 mb-0">太棒了！暂无待跟进学员</p>
            </div>
            {% endif %}
        </div>
        
        <!-- 最近添加的学员 -->
        <div class="list-card mt-4">
            <div class="list-card-header">
                <div class="list-card-title">
                    <i data-lucide="user-plus" style="width:18px;height:18px;margin-right:8px;color:#3B82F6;"></i>
                    最近添加的学员
                </div>
                <a href="{{ url_for('students.list') }}" class="list-card-action">
                    查看全部 →
                </a>
            </div>
            
            {% if stats.recent_students %}
            {% for student in stats.recent_students[:5] %}
            <div class="list-item" onclick="location.href='{{ url_for('students.detail', id=student.id) }}'">
                <div class="list-item-left">
                    <div class="list-item-avatar" style="background:linear-gradient(135deg,#10B981,#059669);">{{ student.name[0] }}</div>
                    <div>
                        <div class="list-item-name">{{ student.name }}</div>
                        <div class="list-item-sub">
                            {{ student.class_name or '未分班' }} · 
                            入学: {{ student.enrollment_date.strftime('%m-%d') if student.enrollment_date else '未设置' }}
                        </div>
                    </div>
                </div>
                <div>
                    {% if student.is_agreement %}
                    <span class="badge" style="background:#DBEAFE;color:#2563EB;">协议班</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-4 text-muted">
                <p class="mb-0">暂无学员数据</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 右侧内容 -->
    <div class="col-lg-4">
        <!-- 快速操作（放在最上面） -->
        <div class="card mb-4" style="border-radius:16px;border:none;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <div class="card-body p-4">
                <h6 class="font-heading mb-3" style="font-weight:600;">
                    <i data-lucide="zap" style="width:16px;height:16px;margin-right:8px;color:#F59E0B;"></i>
                    快速操作
                </h6>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('students.create') }}" class="btn btn-primary" style="border-radius:12px;padding:0.75rem;">
                        <i data-lucide="user-plus" style="width:18px;height:18px;margin-right:0.5rem;"></i>
                        新增学员
                    </a>
                    <a href="{{ url_for('supervision.log_form') }}" class="btn btn-outline-primary" style="border-radius:12px;padding:0.75rem;">
                        <i data-lucide="clipboard-plus" style="width:18px;height:18px;margin-right:0.5rem;"></i>
                        记录督学日志
                    </a>
                    <div class="row g-2">
                        <div class="col-6">
                            <a href="{{ url_for('homework.create') }}" class="btn btn-outline-secondary w-100" style="border-radius:12px;padding:0.6rem;font-size:0.85rem;">
                                <i data-lucide="file-plus" style="width:16px;height:16px;margin-right:4px;"></i>
                                发布作业
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('courses.recording_create') }}" class="btn btn-outline-secondary w-100" style="border-radius:12px;padding:0.6rem;font-size:0.85rem;">
                                <i data-lucide="video" style="width:16px;height:16px;margin-right:4px;"></i>
                                添加录播
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第三阶段新增：待处理事项提醒 -->
        {% if reminders and (reminders.pending_follow_ups > 0 or reminders.attention_students > 0) %}
        <div class="card mb-4" style="border-radius:16px;border:none;box-shadow:0 1px 3px rgba(0,0,0,0.05);background:linear-gradient(135deg,#FEF3C7 0%,#FDE68A 100%);">
            <div class="card-body p-4">
                <h6 class="font-heading mb-3" style="font-weight:600;color:#92400E;">
                    <i data-lucide="bell-ring" style="width:16px;height:16px;margin-right:8px;"></i>
                    待处理事项
                </h6>
                
                {% if reminders.pending_follow_ups > 0 %}
                <div class="d-flex align-items-center justify-content-between py-2 border-bottom" style="border-color:rgba(0,0,0,0.1)!important;">
                    <div class="d-flex align-items-center">
                        <div style="width:36px;height:36px;border-radius:10px;background:#F59E0B;display:flex;align-items:center;justify-content:center;margin-right:12px;">
                            <i data-lucide="clock" style="width:18px;height:18px;color:white;"></i>
                        </div>
                        <div>
                            <div style="font-weight:600;font-size:0.9rem;color:#78350F;">待跟进学员</div>
                            <div style="font-size:0.75rem;color:#92400E;">超过{{ reminders.reminder_days }}天未联系</div>
                        </div>
                    </div>
                    <span class="badge" style="background:#DC2626;color:white;font-size:1rem;padding:0.5rem 0.75rem;">{{ reminders.pending_follow_ups }}</span>
                </div>
                {% endif %}
                
                {% if reminders.attention_students > 0 %}
                <div class="d-flex align-items-center justify-content-between py-2 border-bottom" style="border-color:rgba(0,0,0,0.1)!important;">
                    <div class="d-flex align-items-center">
                        <div style="width:36px;height:36px;border-radius:10px;background:#EF4444;display:flex;align-items:center;justify-content:center;margin-right:12px;">
                            <i data-lucide="alert-triangle" style="width:18px;height:18px;color:white;"></i>
                        </div>
                        <div>
                            <div style="font-weight:600;font-size:0.9rem;color:#78350F;">重点关注学员</div>
                            <div style="font-size:0.75rem;color:#92400E;">需特别关注</div>
                        </div>
                    </div>
                    <span class="badge" style="background:#DC2626;color:white;font-size:1rem;padding:0.5rem 0.75rem;">{{ reminders.attention_students }}</span>
                </div>
                {% endif %}
                
                {% if reminders.today_schedules > 0 %}
                <div class="d-flex align-items-center justify-content-between py-2">
                    <div class="d-flex align-items-center">
                        <div style="width:36px;height:36px;border-radius:10px;background:#10B981;display:flex;align-items:center;justify-content:center;margin-right:12px;">
                            <i data-lucide="calendar" style="width:18px;height:18px;color:white;"></i>
                        </div>
                        <div>
                            <div style="font-weight:600;font-size:0.9rem;color:#78350F;">今日课程</div>
                            <div style="font-size:0.75rem;color:#92400E;">待上课</div>
                        </div>
                    </div>
                    <span class="badge" style="background:#10B981;color:white;font-size:1rem;padding:0.5rem 0.75rem;">{{ reminders.today_schedules }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- 超期未跟进学员列表 -->
        {% if pending_follow_ups %}
        <div class="stat-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-card-title" style="font-size:1rem;">
                    <i data-lucide="clock" style="width:16px;height:16px;margin-right:8px;color:#F59E0B;"></i>
                    超期未跟进
                </div>
                <a href="{{ url_for('students.list') }}?need_attention=1" style="color:var(--primary);font-size:0.8rem;text-decoration:none;">
                    查看全部 →
                </a>
            </div>
            
            {% for student in pending_follow_ups[:5] %}
            <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}" 
                 style="cursor:pointer;" onclick="location.href='{{ url_for('students.detail', id=student.id) }}'">
                <div class="d-flex align-items-center">
                    <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#F59E0B,#D97706);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:0.75rem;margin-right:10px;">
                        {{ student.name[0] }}
                    </div>
                    <div>
                        <div style="font-weight:500;font-size:0.9rem;">{{ student.name }}</div>
                        <div style="font-size:0.75rem;color:#94A3B8;">
                            {% if student.last_follow_up %}
                            {{ student.days_since_follow_up }}天前
                            {% else %}
                            从未跟进
                            {% endif %}
                        </div>
                    </div>
                </div>
                <a href="{{ url_for('supervision.log_form') }}?student_id={{ student.id }}" 
                   class="btn btn-sm btn-warning" style="border-radius:8px;font-size:0.75rem;" 
                   onclick="event.stopPropagation();">
                    跟进
                </a>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- 最近督学记录 -->
        <div class="stat-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-card-title" style="font-size:1rem;">
                    <i data-lucide="clipboard-list" style="width:16px;height:16px;margin-right:8px;color:var(--primary);"></i>
                    最近督学记录
                </div>
                <a href="{{ url_for('supervision.my_logs') }}" style="color:var(--primary);font-size:0.8rem;text-decoration:none;">
                    查看全部 →
                </a>
            </div>
            
            {% if recent_logs %}
            {% for log in recent_logs[:5] %}
            <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}">
                <div class="d-flex align-items-center">
                    <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3B82F6,#8B5CF6);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:0.75rem;margin-right:10px;">
                        {{ log.student.name[0] if log.student else '?' }}
                    </div>
                    <div>
                        <div style="font-weight:500;font-size:0.9rem;">{{ log.student.name if log.student else '未知' }}</div>
                        <div style="font-size:0.75rem;color:#94A3B8;">{{ log.log_date.strftime('%m-%d') if log.log_date else '' }}</div>
                    </div>
                </div>
                {% if log.student_mood %}
                <span class="badge" style="font-size:0.7rem;
                    {% if log.student_mood == '积极' %}background:#DCFCE7;color:#16A34A;
                    {% elif log.student_mood == '平稳' %}background:#DBEAFE;color:#2563EB;
                    {% elif log.student_mood == '焦虑' %}background:#FEF3C7;color:#D97706;
                    {% else %}background:#FEE2E2;color:#DC2626;{% endif %}">
                    {{ log.student_mood }}
                </span>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-3 text-muted">
                <p class="mb-0" style="font-size:0.85rem;">暂无督学记录</p>
            </div>
            {% endif %}
        </div>
        
        <!-- 今日课程 -->
        {% if today_schedules %}
        <div class="stat-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-card-title" style="font-size:1rem;">
                    <i data-lucide="calendar-check" style="width:16px;height:16px;margin-right:8px;color:#10B981;"></i>
                    今日课程
                </div>
                <span class="badge bg-success">{{ today_schedules|length }}节</span>
            </div>
            
            {% for schedule in today_schedules[:4] %}
            <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}">
                <div>
                    <div style="font-weight:500;font-size:0.9rem;">{{ schedule.batch.name }}</div>
                    <div style="font-size:0.75rem;color:#94A3B8;">
                        {{ schedule.subject.short_name or schedule.subject.name if schedule.subject else '-' }}
                        {% if schedule.morning_teacher %} · {{ schedule.morning_teacher.name }}{% endif %}
                    </div>
                </div>
                <span class="badge bg-light text-dark">Day {{ schedule.day_number }}</span>
            </div>
            {% endfor %}
            
            {% if today_schedules|length > 4 %}
            <div class="text-center pt-2">
                <a href="{{ url_for('courses.batch_list') }}" class="small text-muted">查看全部 {{ today_schedules|length }} 节课程</a>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
});
</script>
{% endblock %}
