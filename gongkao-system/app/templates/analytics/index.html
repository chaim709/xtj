{% extends "base.html" %}

{% block title %}数据分析 - 公考培训机构管理系统{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .stat-card .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .stat-card .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .stat-card .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .stat-card .stat-change {
        font-size: 0.75rem;
    }
    
    .chart-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .chart-card .card-header {
        background: transparent;
        border-bottom: 1px solid #f0f0f0;
        padding: 1rem 1.25rem;
    }
    .chart-card .card-header h6 {
        margin: 0;
        font-weight: 600;
    }
    .chart-container {
        height: 300px;
    }
    
    .progress-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    .progress-item:last-child {
        margin-bottom: 0;
    }
    .progress-item .batch-name {
        font-weight: 500;
        font-size: 0.9rem;
    }
    .progress-item .progress {
        height: 8px;
        border-radius: 4px;
    }
    
    .ranking-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .ranking-item:last-child {
        border-bottom: none;
    }
    .ranking-item .rank-num {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.75rem;
    }
    .ranking-item .rank-num.top-3 {
        background: linear-gradient(135deg, #ffd700, #ffb700);
        color: white;
    }
    .ranking-item .rank-name {
        flex: 1;
        font-size: 0.9rem;
    }
    .ranking-item .rank-value {
        font-weight: 600;
        color: var(--bs-primary);
    }
    
    /* 时间范围选择 */
    .time-range-selector {
        display: flex;
        gap: 0.5rem;
    }
    .time-range-selector .btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">
                <i data-lucide="bar-chart-3" class="me-2"></i>数据分析
            </h4>
            <p class="text-muted mb-0 small">查看系统运营数据和统计分析</p>
        </div>
        <div class="time-range-selector">
            <button class="btn btn-outline-primary btn-sm active" data-days="7">近7天</button>
            <button class="btn btn-outline-primary btn-sm" data-days="30">近30天</button>
            <button class="btn btn-outline-primary btn-sm" data-days="90">近90天</button>
        </div>
    </div>
    
    <!-- 统计卡片 -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                            <i data-lucide="users"></i>
                        </div>
                        <div>
                            <div class="stat-value text-primary" id="totalStudents">-</div>
                            <div class="stat-label">学员总数</div>
                        </div>
                    </div>
                    <div class="mt-2 stat-change text-success" id="activeStudents">
                        在学: -
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                            <i data-lucide="user-plus"></i>
                        </div>
                        <div>
                            <div class="stat-value text-success" id="newStudents">-</div>
                            <div class="stat-label">新增学员</div>
                        </div>
                    </div>
                    <div class="mt-2 stat-change text-muted" id="newStudentsPeriod">
                        近30天
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-info bg-opacity-10 text-info me-3">
                            <i data-lucide="clipboard-list"></i>
                        </div>
                        <div>
                            <div class="stat-value text-info" id="totalLogs">-</div>
                            <div class="stat-label">督学记录</div>
                        </div>
                    </div>
                    <div class="mt-2 stat-change text-muted" id="avgLogsPerDay">
                        日均: -
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                            <i data-lucide="alert-triangle"></i>
                        </div>
                        <div>
                            <div class="stat-value text-warning" id="attentionStudents">-</div>
                            <div class="stat-label">需关注学员</div>
                        </div>
                    </div>
                    <div class="mt-2 stat-change text-muted">
                        <a href="{{ url_for('students.list') }}?attention=1" class="text-decoration-none">查看详情 →</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 图表区域 -->
    <div class="row g-3 mb-4">
        <!-- 学员增长趋势 -->
        <div class="col-lg-8">
            <div class="card chart-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6><i data-lucide="trending-up" class="me-2" style="width:18px;height:18px;"></i>学员增长趋势</h6>
                </div>
                <div class="card-body">
                    <div id="trendChart" class="chart-container"></div>
                </div>
            </div>
        </div>
        
        <!-- 学员状态分布 -->
        <div class="col-lg-4">
            <div class="card chart-card h-100">
                <div class="card-header">
                    <h6><i data-lucide="pie-chart" class="me-2" style="width:18px;height:18px;"></i>学员状态分布</h6>
                </div>
                <div class="card-body">
                    <div id="statusChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-3 mb-4">
        <!-- 薄弱知识点分布 -->
        <div class="col-lg-6">
            <div class="card chart-card h-100">
                <div class="card-header">
                    <h6><i data-lucide="target" class="me-2" style="width:18px;height:18px;"></i>薄弱知识点分布 (Top 10)</h6>
                </div>
                <div class="card-body">
                    <div id="weaknessChart" class="chart-container"></div>
                </div>
            </div>
        </div>
        
        <!-- 督学工作量排行 -->
        <div class="col-lg-6">
            <div class="card chart-card h-100">
                <div class="card-header">
                    <h6><i data-lucide="award" class="me-2" style="width:18px;height:18px;"></i>督学工作量排行</h6>
                </div>
                <div class="card-body">
                    <div id="rankingList">
                        <!-- 动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-3">
        <!-- 班次课程进度 -->
        <div class="col-lg-6">
            <div class="card chart-card h-100">
                <div class="card-header">
                    <h6><i data-lucide="calendar-check" class="me-2" style="width:18px;height:18px;"></i>班次课程进度</h6>
                </div>
                <div class="card-body" id="progressList">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
        
        <!-- 考勤统计 -->
        <div class="col-lg-6">
            <div class="card chart-card h-100">
                <div class="card-header">
                    <h6><i data-lucide="check-square" class="me-2" style="width:18px;height:18px;"></i>考勤统计</h6>
                </div>
                <div class="card-body">
                    <div id="attendanceChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDays = 30;
    let trendChart, statusChart, weaknessChart, attendanceChart;
    
    // 初始化图表
    initCharts();
    
    // 加载数据
    loadAllData();
    
    // 时间范围选择
    document.querySelectorAll('.time-range-selector .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelector('.time-range-selector .btn.active').classList.remove('active');
            this.classList.add('active');
            currentDays = parseInt(this.dataset.days);
            document.getElementById('newStudentsPeriod').textContent = `近${currentDays}天`;
            loadAllData();
        });
    });
    
    // 窗口大小变化时重绘图表
    window.addEventListener('resize', function() {
        if (trendChart) trendChart.resize();
        if (statusChart) statusChart.resize();
        if (weaknessChart) weaknessChart.resize();
        if (attendanceChart) attendanceChart.resize();
    });
    
    function initCharts() {
        trendChart = echarts.init(document.getElementById('trendChart'));
        statusChart = echarts.init(document.getElementById('statusChart'));
        weaknessChart = echarts.init(document.getElementById('weaknessChart'));
        attendanceChart = echarts.init(document.getElementById('attendanceChart'));
    }
    
    function loadAllData() {
        loadOverview();
        loadTrend();
        loadStatusDistribution();
        loadWeakness();
        loadRanking();
        loadProgress();
        loadAttendance();
    }
    
    // 加载概览数据
    function loadOverview() {
        fetch(`/analytics/api/overview?days=${currentDays}`)
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const d = res.data;
                    document.getElementById('totalStudents').textContent = d.students.total;
                    document.getElementById('activeStudents').textContent = `在学: ${d.students.active}`;
                    document.getElementById('newStudents').textContent = d.students.new;
                    document.getElementById('totalLogs').textContent = d.supervision.total_logs;
                    document.getElementById('avgLogsPerDay').textContent = `日均: ${d.supervision.avg_per_day}`;
                    document.getElementById('attentionStudents').textContent = d.students.attention;
                }
            });
    }
    
    // 加载趋势图
    function loadTrend() {
        fetch(`/analytics/api/student-trend?days=${currentDays}`)
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: res.data.dates,
                            axisLine: { lineStyle: { color: '#e0e0e0' } },
                            axisLabel: { color: '#666' }
                        },
                        yAxis: {
                            type: 'value',
                            axisLine: { show: false },
                            axisTick: { show: false },
                            splitLine: { lineStyle: { color: '#f0f0f0' } },
                            axisLabel: { color: '#666' }
                        },
                        series: [{
                            name: '新增学员',
                            type: 'bar',
                            data: res.data.counts,
                            barWidth: '60%',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#83bff6' },
                                    { offset: 1, color: '#188df0' }
                                ]),
                                borderRadius: [4, 4, 0, 0]
                            }
                        }]
                    };
                    trendChart.setOption(option);
                }
            });
    }
    
    // 加载状态分布
    function loadStatusDistribution() {
        fetch('/analytics/api/student-status')
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            right: '5%',
                            top: 'center'
                        },
                        series: [{
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['35%', '50%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 8,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 14,
                                    fontWeight: 'bold'
                                }
                            },
                            data: res.data.map(d => ({
                                name: d.name,
                                value: d.value,
                                itemStyle: { color: d.color }
                            }))
                        }]
                    };
                    statusChart.setOption(option);
                }
            });
    }
    
    // 加载薄弱点分布
    function loadWeakness() {
        fetch('/analytics/api/weakness-distribution?limit=10')
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'value',
                            axisLine: { show: false },
                            axisTick: { show: false },
                            splitLine: { lineStyle: { color: '#f0f0f0' } }
                        },
                        yAxis: {
                            type: 'category',
                            data: res.data.modules.reverse(),
                            axisLine: { lineStyle: { color: '#e0e0e0' } },
                            axisTick: { show: false }
                        },
                        series: [{
                            type: 'bar',
                            data: res.data.counts.reverse(),
                            barWidth: '60%',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#ff9800' },
                                    { offset: 1, color: '#f44336' }
                                ]),
                                borderRadius: [0, 4, 4, 0]
                            }
                        }]
                    };
                    weaknessChart.setOption(option);
                }
            });
    }
    
    // 加载排行
    function loadRanking() {
        fetch(`/analytics/api/supervision-ranking?days=${currentDays}`)
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const container = document.getElementById('rankingList');
                    if (res.data.names.length === 0) {
                        container.innerHTML = '<div class="text-center text-muted py-4">暂无数据</div>';
                        return;
                    }
                    let html = '';
                    res.data.names.forEach((name, i) => {
                        const isTop3 = i < 3;
                        html += `
                            <div class="ranking-item">
                                <div class="rank-num ${isTop3 ? 'top-3' : ''}">${i + 1}</div>
                                <div class="rank-name">${name}</div>
                                <div class="rank-value">${res.data.counts[i]} 条</div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
            });
    }
    
    // 加载进度
    function loadProgress() {
        fetch('/analytics/api/batch-progress')
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const container = document.getElementById('progressList');
                    if (res.data.length === 0) {
                        container.innerHTML = '<div class="text-center text-muted py-4">暂无进行中的班次</div>';
                        return;
                    }
                    let html = '';
                    res.data.forEach(b => {
                        const progressColor = b.progress >= 80 ? 'bg-success' : (b.progress >= 50 ? 'bg-info' : 'bg-primary');
                        html += `
                            <div class="progress-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="batch-name">${b.name}</span>
                                    <span class="small text-muted">${b.enrolled_count}人 | ${b.completed_days}/${b.total_days}天</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar ${progressColor}" style="width: ${b.progress}%"></div>
                                </div>
                                <div class="small text-muted mt-1">进度: ${b.progress}%</div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
            });
    }
    
    // 加载考勤统计
    function loadAttendance() {
        fetch('/analytics/api/attendance-stats')
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    const d = res.data;
                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'horizontal',
                            bottom: '5%'
                        },
                        series: [{
                            type: 'pie',
                            radius: '60%',
                            center: ['50%', '45%'],
                            data: [
                                { value: d.present, name: '出勤', itemStyle: { color: '#4CAF50' } },
                                { value: d.late, name: '迟到', itemStyle: { color: '#FF9800' } },
                                { value: d.leave, name: '请假', itemStyle: { color: '#2196F3' } },
                                { value: d.absent, name: '缺勤', itemStyle: { color: '#f44336' } }
                            ],
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }],
                        graphic: [{
                            type: 'text',
                            left: 'center',
                            top: '40%',
                            style: {
                                text: d.rate + '%',
                                fontSize: 24,
                                fontWeight: 'bold',
                                fill: '#333'
                            }
                        }, {
                            type: 'text',
                            left: 'center',
                            top: '50%',
                            style: {
                                text: '出勤率',
                                fontSize: 12,
                                fill: '#999'
                            }
                        }]
                    };
                    attendanceChart.setOption(option);
                }
            });
    }
});
</script>
{% endblock %}
