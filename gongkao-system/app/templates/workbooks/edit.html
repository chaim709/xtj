{% extends "base.html" %}

{% block title %}编辑题册 - {{ workbook.name }}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">编辑题册</h1>
        <p class="text-muted mb-0">{{ workbook.name }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('workbooks.view', id=workbook.id) }}" class="btn btn-outline-primary">
            <i data-lucide="eye" class="me-1"></i> 查看
        </a>
        <a href="{{ url_for('workbooks.index') }}" class="btn btn-outline-secondary">
            <i data-lucide="arrow-left" class="me-1"></i> 返回
        </a>
    </div>
</div>

<div class="row">
    <!-- 基本信息 -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">基本信息</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('workbooks.edit', id=workbook.id) }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">题册名称</label>
                        <input type="text" name="name" class="form-control" value="{{ workbook.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea name="description" class="form-control" rows="3">{{ workbook.description or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">分类</label>
                        <input type="text" name="category" class="form-control" value="{{ workbook.category or '' }}" list="categoryList">
                        <datalist id="categoryList">
                            {% for cat in categories %}
                            <option value="{{ cat }}">
                            {% endfor %}
                        </datalist>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i data-lucide="save" class="me-1"></i> 保存修改
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 添加题目 -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">添加题目</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('workbooks.add_questions', id=workbook.id) }}" method="POST">
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="搜索题目..." id="questionSearch" oninput="filterQuestions()">
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;" id="questionList">
                        {% for q in questions %}
                        <div class="form-check py-2 border-bottom question-item" data-stem="{{ q.stem|lower }}">
                            <input class="form-check-input" type="checkbox" name="question_ids" value="{{ q.id }}" id="q{{ q.id }}">
                            <label class="form-check-label" for="q{{ q.id }}">
                                <small class="text-muted">#{{ q.id }}</small>
                                {{ q.stem[:40] }}{% if q.stem|length > 40 %}...{% endif %}
                            </label>
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-3">暂无可添加的题目</p>
                        {% endfor %}
                    </div>
                    {% if questions %}
                    <button type="submit" class="btn btn-success w-100 mt-3">
                        <i data-lucide="plus" class="me-1"></i> 添加选中题目
                    </button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    
    <!-- 已添加的题目 -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">题目列表</h5>
                <span class="badge bg-primary">共 {{ items|length }} 题</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="60">序号</th>
                            <th>题干</th>
                            <th width="100">分类</th>
                            <th width="60">答案</th>
                            <th width="80">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>{{ item.order }}</td>
                            <td>
                                <a href="{{ url_for('questions.view', id=item.question_id) }}">
                                    {{ item.question.stem[:60] }}{% if item.question.stem|length > 60 %}...{% endif %}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ item.question.subcategory or item.question.category or '-' }}</span>
                            </td>
                            <td>
                                <span class="badge bg-success">{{ item.question.answer or '-' }}</span>
                            </td>
                            <td>
                                <form action="{{ url_for('workbooks.remove_question', id=workbook.id, item_id=item.id) }}" method="POST" class="d-inline"
                                      onsubmit="return confirm('确定移除此题目？')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                暂无题目，请从左侧添加
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function filterQuestions() {
    const keyword = document.getElementById('questionSearch').value.toLowerCase();
    document.querySelectorAll('.question-item').forEach(item => {
        const stem = item.dataset.stem;
        item.style.display = stem.includes(keyword) ? '' : 'none';
    });
}
</script>
{% endblock %}
