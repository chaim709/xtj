{% extends "base.html" %}

{% block title %}ç£å­¦ç®¡ç† - å…¬è€ƒåŸ¹è®­ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
    .overview-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        text-align: center;
        transition: all var(--transition-normal);
        border: 1px solid var(--border-light);
        cursor: pointer;
    }
    
    .overview-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .overview-card.highlight {
        background: var(--gradient-primary);
        color: white;
        border: none;
    }
    
    .overview-card.highlight .overview-label {
        color: rgba(255,255,255,0.85);
    }
    
    .overview-card.highlight .overview-value {
        color: white;
    }
    
    .overview-card.warning {
        border-color: var(--warning);
        background: var(--warning-50);
    }
    
    .overview-card.warning .overview-value {
        color: var(--warning-600);
    }
    
    .overview-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    
    .overview-value {
        font-family: 'Poppins', sans-serif;
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    /* Tabæ ·å¼ä¼˜åŒ– */
    .nav-tabs-custom {
        border-bottom: 2px solid var(--border-light);
        gap: 0.5rem;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        padding: 0.75rem 1.5rem;
        color: var(--text-secondary);
        font-weight: 500;
        transition: all var(--transition-normal);
        position: relative;
    }
    
    .nav-tabs-custom .nav-link:hover {
        color: var(--primary);
        background: var(--primary-light);
    }
    
    .nav-tabs-custom .nav-link.active {
        color: var(--primary);
        background: transparent;
    }
    
    .nav-tabs-custom .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary);
        border-radius: 3px 3px 0 0;
    }
    
    /* å­¦å‘˜å¡ç‰‡æ ·å¼ */
    .student-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 1px solid var(--border-light);
        transition: all var(--transition-normal);
    }
    
    .student-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }
    
    .student-card.needs-followup {
        border-left: 4px solid var(--warning);
        background: var(--warning-50);
    }
    
    .student-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        flex-shrink: 0;
    }
    
    .student-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }
    
    .student-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .mood-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
    }
    
    .mood-badge.positive { background: var(--success-light); color: var(--success-text); }
    .mood-badge.neutral { background: var(--slate-100); color: var(--slate-600); }
    .mood-badge.warning { background: var(--warning-light); color: var(--warning-text); }
    .mood-badge.negative { background: var(--danger-light); color: var(--danger-text); }
    
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-mini {
        height: 6px;
        background: var(--border-light);
        border-radius: var(--radius-full);
        overflow: hidden;
    }
    
    .progress-mini .progress-bar {
        background: var(--gradient-primary);
        border-radius: var(--radius-full);
    }
    
    /* æ—¶é—´çº¿æ ·å¼ */
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1.5rem;
        border-left: 2px solid var(--border-light);
    }
    
    .timeline-item:last-child {
        border-left-color: transparent;
        padding-bottom: 0;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 0;
        width: 10px;
        height: 10px;
        background: var(--primary);
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 2px var(--primary);
    }
    
    .timeline-date {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }
    
    .timeline-content {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 1rem;
        border: 1px solid var(--border-light);
    }
    
    /* å¿«é€Ÿæ“ä½œæŒ‰é’®ç»„ */
    .quick-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .quick-actions .btn {
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
    }
    
    /* ç­›é€‰æ¡æ ·å¼ */
    .filter-bar {
        background: var(--background);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }
    
    .filter-bar .form-select,
    .filter-bar .form-control {
        width: auto;
        min-width: 150px;
    }
    
    /* å›¾è¡¨å®¹å™¨ */
    .chart-container {
        position: relative;
        height: 250px;
    }
    
    /* æ¨¡æ€æ¡†å†…åˆ—è¡¨ */
    .modal-student-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .modal-student-list .form-check {
        padding: 0.5rem;
        border-radius: var(--radius-sm);
        transition: background var(--transition-fast);
    }
    
    .modal-student-list .form-check:hover {
        background: var(--background);
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }
    
    .empty-state-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1rem;
        color: var(--text-muted);
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡å°å›¾æ ‡ */
    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
    }
    
    .stat-icon.blue { background: var(--brand-100); color: var(--brand-600); }
    .stat-icon.orange { background: var(--warning-100); color: var(--warning-600); }
    .stat-icon.green { background: var(--success-100); color: var(--success-600); }
    .stat-icon.purple { background: var(--purple-100); color: var(--purple-600); }
</style>
{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="font-heading mb-1">ç£å­¦ç®¡ç†</h4>
        <p class="text-muted mb-0">ä¸€ç«™å¼ç®¡ç†å­¦å‘˜ç£å­¦å·¥ä½œã€å­¦ä¹ è®¡åˆ’å’Œç£å­¦è®°å½•</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#batchPlanModal">
            <i data-lucide="copy-plus" style="width:16px;height:16px;margin-right:6px;"></i>
            æ‰¹é‡åˆ›å»ºè®¡åˆ’
        </button>
        <a href="{{ url_for('supervision.log_form') }}" class="btn btn-primary">
            <i data-lucide="plus" style="width:16px;height:16px;margin-right:6px;"></i>
            è®°å½•æ—¥å¿—
        </a>
    </div>
</div>

<!-- æ¦‚è§ˆç»Ÿè®¡å¡ç‰‡ -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="overview-card highlight" onclick="switchTab('students', 'pending')">
            <div class="overview-label">å¾…è·Ÿè¿›å­¦å‘˜</div>
            <div class="overview-value" id="stat-pending">{{ overview.pending_followup }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="overview-card {% if overview.overdue_tasks > 0 %}warning{% endif %}" onclick="switchTab('plans')">
            <div class="overview-label">é€¾æœŸä»»åŠ¡</div>
            <div class="overview-value" id="stat-overdue">{{ overview.overdue_tasks }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="overview-card" onclick="switchTab('logs')">
            <div class="overview-label">æœ¬å‘¨å·²è”ç³»</div>
            <div class="overview-value" id="stat-contacted">{{ overview.week_contacted }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="overview-card" onclick="switchTab('stats')">
            <div class="overview-label">è®¡åˆ’å®Œæˆç‡</div>
            <div class="overview-value" id="stat-progress">{{ overview.avg_plan_progress }}%</div>
        </div>
    </div>
</div>

<!-- Tabå¯¼èˆª -->
<ul class="nav nav-tabs nav-tabs-custom mb-4" id="manageTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students-pane" type="button">
            <i data-lucide="users" style="width:16px;height:16px;margin-right:6px;"></i>
            å­¦å‘˜ç£å­¦
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="plans-tab" data-bs-toggle="tab" data-bs-target="#plans-pane" type="button">
            <i data-lucide="calendar-check" style="width:16px;height:16px;margin-right:6px;"></i>
            å­¦ä¹ è®¡åˆ’
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-pane" type="button">
            <i data-lucide="file-text" style="width:16px;height:16px;margin-right:6px;"></i>
            ç£å­¦è®°å½•
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-pane" type="button">
            <i data-lucide="bar-chart-3" style="width:16px;height:16px;margin-right:6px;"></i>
            ä¸šç»©ç»Ÿè®¡
        </button>
    </li>
</ul>

<!-- Tabå†…å®¹ -->
<div class="tab-content" id="manageTabContent">
    <!-- å­¦å‘˜ç£å­¦Tab -->
    <div class="tab-pane fade show active" id="students-pane" role="tabpanel">
        <!-- ç­›é€‰æ¡ -->
        <div class="filter-bar">
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary" style="font-size:0.85rem;">ç­›é€‰ï¼š</span>
                <select class="form-select form-select-sm" id="studentFilter" style="width:auto;">
                    <option value="all">å…¨éƒ¨å­¦å‘˜</option>
                    <option value="pending" selected>å¾…è·Ÿè¿›</option>
                    <option value="contacted">æœ¬å‘¨å·²è”ç³»</option>
                    <option value="overdue">æœ‰é€¾æœŸä»»åŠ¡</option>
                </select>
            </div>
            {% if current_user.is_admin() %}
            <div class="ms-auto d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#assignModal">
                    <i data-lucide="user-plus" style="width:14px;height:14px;margin-right:4px;"></i>
                    åˆ†é…å­¦å‘˜
                </button>
            </div>
            {% endif %}
        </div>
        
        <!-- å­¦å‘˜åˆ—è¡¨ -->
        <div class="row" id="studentList">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- åˆ†é¡µ -->
        <nav id="studentPagination" class="mt-4"></nav>
    </div>
    
    <!-- å­¦ä¹ è®¡åˆ’Tab -->
    <div class="tab-pane fade" id="plans-pane" role="tabpanel">
        <!-- ç­›é€‰æ¡ -->
        <div class="filter-bar">
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary" style="font-size:0.85rem;">çŠ¶æ€ï¼š</span>
                <select class="form-select form-select-sm" id="planStatusFilter" style="width:auto;">
                    <option value="active">è¿›è¡Œä¸­</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="paused">å·²æš‚åœ</option>
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div class="ms-auto">
                <a href="{{ url_for('supervision.templates') }}" class="btn btn-sm btn-outline-primary">
                    <i data-lucide="layout-template" style="width:14px;height:14px;margin-right:4px;"></i>
                    ç®¡ç†æ¨¡æ¿
                </a>
            </div>
        </div>
        
        <!-- è®¡åˆ’åˆ—è¡¨ -->
        <div class="table-responsive">
            <table class="table" id="plansTable">
                <thead>
                    <tr>
                        <th>å­¦å‘˜</th>
                        <th>è®¡åˆ’åç§°</th>
                        <th>é˜¶æ®µ</th>
                        <th>ä»»åŠ¡è¿›åº¦</th>
                        <th>é€¾æœŸä»»åŠ¡</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="plansList">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <nav id="planPagination" class="mt-4"></nav>
    </div>
    
    <!-- ç£å­¦è®°å½•Tab -->
    <div class="tab-pane fade" id="logs-pane" role="tabpanel">
        <!-- ç­›é€‰æ¡ -->
        <div class="filter-bar">
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary" style="font-size:0.85rem;">æ—¥æœŸï¼š</span>
                <input type="date" class="form-control form-control-sm" id="logStartDate" style="width:auto;">
                <span class="text-muted">è‡³</span>
                <input type="date" class="form-control form-control-sm" id="logEndDate" style="width:auto;">
            </div>
            <button class="btn btn-sm btn-primary" onclick="loadLogs()">ç­›é€‰</button>
        </div>
        
        <!-- æ—¶é—´çº¿è§†å›¾ -->
        <div id="logsTimeline" class="ps-3">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        </div>
        
        <nav id="logPagination" class="mt-4"></nav>
    </div>
    
    <!-- ä¸šç»©ç»Ÿè®¡Tab -->
    <div class="tab-pane fade" id="stats-pane" role="tabpanel">
        <div class="row g-4">
            <!-- å·¥ä½œé‡ç»Ÿè®¡ -->
            <div class="col-lg-6">
                <div class="card" style="border-radius:var(--radius-lg);border:1px solid var(--border-light);">
                    <div class="card-header bg-transparent border-0 pt-4 pb-0">
                        <h6 class="font-heading mb-0">
                            <i data-lucide="bar-chart" style="width:16px;height:16px;margin-right:8px;color:var(--primary);"></i>
                            ç£å­¦å·¥ä½œé‡
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="workloadChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¿ƒæ€åˆ†å¸ƒ -->
            <div class="col-lg-6">
                <div class="card" style="border-radius:var(--radius-lg);border:1px solid var(--border-light);">
                    <div class="card-header bg-transparent border-0 pt-4 pb-0">
                        <h6 class="font-heading mb-0">
                            <i data-lucide="smile" style="width:16px;height:16px;margin-right:8px;color:var(--primary);"></i>
                            å­¦å‘˜å¿ƒæ€åˆ†å¸ƒ
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="moodChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ—¥è¶‹åŠ¿ -->
            <div class="col-12">
                <div class="card" style="border-radius:var(--radius-lg);border:1px solid var(--border-light);">
                    <div class="card-header bg-transparent border-0 pt-4 pb-0">
                        <h6 class="font-heading mb-0">
                            <i data-lucide="trending-up" style="width:16px;height:16px;margin-right:8px;color:var(--primary);"></i>
                            ç£å­¦å·¥ä½œè¶‹åŠ¿ï¼ˆè¿‘30å¤©ï¼‰
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height:200px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡åˆ›å»ºè®¡åˆ’æ¨¡æ€æ¡† -->
<div class="modal fade" id="batchPlanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:var(--radius-lg);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title font-heading">æ‰¹é‡åˆ›å»ºå­¦ä¹ è®¡åˆ’</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="batchPlanForm">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è®¡åˆ’æ¨¡æ¿</label>
                        <select class="form-select" name="template_id" required>
                            <option value="">è¯·é€‰æ‹©æ¨¡æ¿</option>
                            {% for t in templates %}
                            <option value="{{ t.id }}">{{ t.name }} ({{ t.phase_display }}, {{ t.duration_days }}å¤©)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å­¦å‘˜</label>
                        <div class="modal-student-list border rounded p-2" id="batchStudentList">
                            <p class="text-muted text-center my-3">åŠ è½½å­¦å‘˜åˆ—è¡¨...</p>
                        </div>
                        <small class="text-muted">å·²é€‰æ‹© <span id="selectedStudentCount">0</span> åå­¦å‘˜</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitBatchPlan()">
                    <i data-lucide="check" style="width:16px;height:16px;margin-right:6px;"></i>
                    åˆ›å»ºè®¡åˆ’
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†é…å­¦å‘˜æ¨¡æ€æ¡† -->
{% if current_user.is_admin() %}
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:var(--radius-lg);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title font-heading">åˆ†é…å­¦å‘˜ç»™ç£å­¦è€å¸ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignForm">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©ç£å­¦è€å¸ˆ</label>
                        <select class="form-select" name="supervisor_id" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            {% for s in supervisors %}
                            <option value="{{ s.id }}">{{ s.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å­¦å‘˜</label>
                        <div class="modal-student-list border rounded p-2" id="assignStudentList">
                            <p class="text-muted text-center my-3">åŠ è½½å­¦å‘˜åˆ—è¡¨...</p>
                        </div>
                        <small class="text-muted">å·²é€‰æ‹© <span id="assignStudentCount">0</span> åå­¦å‘˜</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitAssign()">
                    <i data-lucide="check" style="width:16px;height:16px;margin-right:6px;"></i>
                    ç¡®è®¤åˆ†é…
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- å¿«é€Ÿè®°å½•æ—¥å¿—æ¨¡æ€æ¡† -->
<div class="modal fade" id="quickLogModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:var(--radius-lg);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title font-heading">å¿«é€Ÿè®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickLogForm">
                    <input type="hidden" name="student_id" id="quickLogStudentId">
                    <div class="mb-3">
                        <label class="form-label">å­¦å‘˜ï¼š<strong id="quickLogStudentName"></strong></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ²Ÿé€šæ–¹å¼</label>
                        <select class="form-select" name="contact_type">
                            <option value="å¾®ä¿¡">å¾®ä¿¡</option>
                            <option value="ç”µè¯">ç”µè¯</option>
                            <option value="é¢è°ˆ">é¢è°ˆ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å­¦ç”Ÿå¿ƒæ€</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="student_mood" value="ç§¯æ" class="d-none"> ğŸ˜Š ç§¯æ
                            </label>
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="student_mood" value="å¹³ç¨³" class="d-none"> ğŸ˜ å¹³ç¨³
                            </label>
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="student_mood" value="ç„¦è™‘" class="d-none"> ğŸ˜Ÿ ç„¦è™‘
                            </label>
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="student_mood" value="ä½è½" class="d-none"> ğŸ˜¢ ä½è½
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å­¦ä¹ çŠ¶æ€</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="study_status" value="ä¼˜ç§€" class="d-none"> ä¼˜ç§€
                            </label>
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="study_status" value="è‰¯å¥½" class="d-none"> è‰¯å¥½
                            </label>
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="study_status" value="ä¸€èˆ¬" class="d-none"> ä¸€èˆ¬
                            </label>
                            <label class="btn btn-outline-secondary btn-sm">
                                <input type="radio" name="study_status" value="è¾ƒå·®" class="d-none"> è¾ƒå·®
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ²Ÿé€šå†…å®¹</label>
                        <textarea class="form-control" name="content" rows="3" placeholder="ç®€è¦è®°å½•æ²Ÿé€šå†…å®¹..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickLog()">
                    <i data-lucide="check" style="width:16px;height:16px;margin-right:6px;"></i>
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let studentsPage = 1;
let plansPage = 1;
let logsPage = 1;
let workloadChart, moodChart, trendChart;

$(document).ready(function() {
    lucide.createIcons();
    
    // åˆå§‹åŠ è½½
    loadStudents();
    
    // Tabåˆ‡æ¢æ—¶åŠ è½½æ•°æ®
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
        const target = $(e.target).attr('data-bs-target');
        if (target === '#plans-pane') loadPlans();
        else if (target === '#logs-pane') loadLogs();
        else if (target === '#stats-pane') loadStats();
    });
    
    // ç­›é€‰å˜åŒ–
    $('#studentFilter').change(function() {
        studentsPage = 1;
        loadStudents();
    });
    
    $('#planStatusFilter').change(function() {
        plansPage = 1;
        loadPlans();
    });
    
    // å¿ƒæ€/çŠ¶æ€é€‰æ‹©æ ·å¼
    $('#quickLogModal').on('show.bs.modal', function() {
        $(this).find('label.btn').removeClass('btn-primary').addClass('btn-outline-secondary');
    });
    
    $('#quickLogForm label.btn').click(function() {
        const group = $(this).find('input').attr('name');
        $(`#quickLogForm label.btn:has(input[name="${group}"])`).removeClass('btn-primary').addClass('btn-outline-secondary');
        $(this).removeClass('btn-outline-secondary').addClass('btn-primary');
    });
    
    // æ¨¡æ€æ¡†æ‰“å¼€æ—¶åŠ è½½å­¦å‘˜åˆ—è¡¨
    $('#batchPlanModal').on('show.bs.modal', loadBatchStudentList);
    $('#assignModal').on('show.bs.modal', loadAssignStudentList);
});

function switchTab(tabName, filter) {
    $(`#${tabName}-tab`).tab('show');
    if (filter && tabName === 'students') {
        $('#studentFilter').val(filter);
        loadStudents();
    }
}

// åŠ è½½å­¦å‘˜åˆ—è¡¨
function loadStudents() {
    const filter = $('#studentFilter').val();
    $.get('{{ url_for("supervision.manage_students") }}', {
        filter: filter,
        page: studentsPage
    }, function(data) {
        renderStudents(data);
    });
}

function renderStudents(data) {
    let html = '';
    if (data.items.length === 0) {
        html = `
            <div class="col-12">
                <div class="empty-state">
                    <i data-lucide="users" class="empty-state-icon"></i>
                    <h6>æš‚æ— å­¦å‘˜</h6>
                    <p class="text-muted">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å­¦å‘˜</p>
                </div>
            </div>
        `;
    } else {
        data.items.forEach(function(s) {
            const needsClass = s.needs_followup ? 'needs-followup' : '';
            const moodClass = getMoodClass(s.last_mood);
            const daysSince = s.days_since_contact !== null ? `${s.days_since_contact}å¤©å‰` : 'ä»æœªè”ç³»';
            
            html += `
                <div class="col-lg-6 col-xl-4">
                    <div class="student-card ${needsClass}">
                        <div class="d-flex align-items-start gap-3">
                            <div class="student-avatar">${s.name.charAt(0)}</div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="student-name">${s.name}</div>
                                        <div class="student-meta">${s.phone || 'æœªå¡«å†™ç”µè¯'}</div>
                                    </div>
                                    ${s.last_mood ? `<span class="mood-badge ${moodClass}">${s.last_mood}</span>` : ''}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">æœ€åè”ç³»ï¼š${daysSince}</small>
                                    ${s.current_plan ? `
                                        <div class="mt-1">
                                            <small class="text-muted">${s.current_plan}</small>
                                            <div class="progress-mini mt-1">
                                                <div class="progress-bar" style="width:${s.plan_progress}%"></div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="quick-actions mt-3">
                                    <button class="btn btn-primary btn-sm" onclick="openQuickLog(${s.id}, '${s.name}')">
                                        <i data-lucide="edit-3" style="width:12px;height:12px;"></i> è®°å½•
                                    </button>
                                    <a href="{{ url_for('students.detail', id=0) }}".replace('/0', '/' + s.id) class="btn btn-outline-secondary btn-sm">
                                        <i data-lucide="user" style="width:12px;height:12px;"></i> è¯¦æƒ…
                                    </a>
                                    <a href="{{ url_for('supervision.history', student_id=0) }}".replace('/0', '/' + s.id) class="btn btn-outline-secondary btn-sm">
                                        <i data-lucide="history" style="width:12px;height:12px;"></i> å†å²
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    $('#studentList').html(html);
    lucide.createIcons();
    renderPagination('#studentPagination', data, 'studentsPage', loadStudents);
}

function getMoodClass(mood) {
    if (!mood) return '';
    if (mood === 'ç§¯æ') return 'positive';
    if (mood === 'å¹³ç¨³') return 'neutral';
    if (mood === 'ç„¦è™‘') return 'warning';
    return 'negative';
}

// åŠ è½½å­¦ä¹ è®¡åˆ’
function loadPlans() {
    const status = $('#planStatusFilter').val();
    $.get('{{ url_for("supervision.manage_plans") }}', {
        status: status,
        page: plansPage
    }, function(data) {
        renderPlans(data);
    });
}

function renderPlans(data) {
    let html = '';
    if (data.items.length === 0) {
        html = '<tr><td colspan="7" class="text-center py-4 text-muted">æš‚æ— å­¦ä¹ è®¡åˆ’</td></tr>';
    } else {
        data.items.forEach(function(p) {
            const statusClass = p.status === 'active' ? 'success' : (p.status === 'paused' ? 'warning' : 'secondary');
            html += `
                <tr>
                    <td><strong>${p.student_name || '-'}</strong></td>
                    <td>${p.name}</td>
                    <td><span class="badge bg-light text-dark">${p.phase_display}</span></td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress-mini flex-grow-1" style="width:100px;">
                                <div class="progress-bar" style="width:${p.task_progress}%"></div>
                            </div>
                            <span class="text-muted" style="font-size:0.8rem;">${p.task_progress}%</span>
                        </div>
                    </td>
                    <td>
                        ${p.overdue_tasks > 0 ? `<span class="badge bg-danger">${p.overdue_tasks}</span>` : '<span class="text-muted">0</span>'}
                    </td>
                    <td><span class="badge bg-${statusClass}">${p.status_display}</span></td>
                    <td>
                        <a href="{{ url_for('plans.detail', plan_id=0) }}".replace('/0', '/' + p.id) class="btn btn-sm btn-outline-primary">æŸ¥çœ‹</a>
                    </td>
                </tr>
            `;
        });
    }
    
    $('#plansList').html(html);
    renderPagination('#planPagination', data, 'plansPage', loadPlans);
}

// åŠ è½½ç£å­¦è®°å½•
function loadLogs() {
    const startDate = $('#logStartDate').val();
    const endDate = $('#logEndDate').val();
    
    $.get('{{ url_for("supervision.manage_logs") }}', {
        start_date: startDate,
        end_date: endDate,
        page: logsPage
    }, function(data) {
        renderLogs(data);
    });
}

function renderLogs(data) {
    let html = '';
    if (data.items.length === 0) {
        html = `
            <div class="empty-state">
                <i data-lucide="file-text" class="empty-state-icon"></i>
                <h6>æš‚æ— ç£å­¦è®°å½•</h6>
                <p class="text-muted">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰è®°å½•</p>
            </div>
        `;
    } else {
        data.items.forEach(function(log) {
            const moodClass = getMoodClass(log.student_mood);
            html += `
                <div class="timeline-item">
                    <div class="timeline-date">${log.log_date}</div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong>${log.student_name || 'æœªçŸ¥å­¦å‘˜'}</strong>
                            <div>
                                ${log.student_mood ? `<span class="mood-badge ${moodClass}">${log.student_mood}</span>` : ''}
                                ${log.study_status ? `<span class="mood-badge neutral ms-1">${log.study_status}</span>` : ''}
                            </div>
                        </div>
                        <p class="mb-2 text-secondary" style="font-size:0.9rem;">${log.content || 'æ— å†…å®¹'}</p>
                        <small class="text-muted">
                            ${log.contact_type || ''} 
                            ${log.contact_duration ? `Â· ${log.contact_duration}åˆ†é’Ÿ` : ''}
                        </small>
                    </div>
                </div>
            `;
        });
    }
    
    $('#logsTimeline').html(html);
    lucide.createIcons();
    renderPagination('#logPagination', data, 'logsPage', loadLogs);
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
function loadStats() {
    $.get('{{ url_for("supervision.manage_stats") }}', function(data) {
        renderStats(data);
    });
}

function renderStats(data) {
    // é”€æ¯æ—§å›¾è¡¨
    if (workloadChart) workloadChart.destroy();
    if (moodChart) moodChart.destroy();
    if (trendChart) trendChart.destroy();
    
    // å·¥ä½œé‡å›¾è¡¨
    if (data.workload && data.workload.length > 0) {
        const ctx1 = document.getElementById('workloadChart').getContext('2d');
        workloadChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: data.workload.map(w => w.supervisor_name),
                datasets: [{
                    label: 'ç£å­¦è®°å½•æ•°',
                    data: data.workload.map(w => w.log_count),
                    backgroundColor: 'rgba(37, 99, 235, 0.8)',
                }, {
                    label: 'è”ç³»å­¦å‘˜æ•°',
                    data: data.workload.map(w => w.student_count),
                    backgroundColor: 'rgba(139, 92, 246, 0.8)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    
    // å¿ƒæ€åˆ†å¸ƒå›¾è¡¨
    const moodLabels = Object.keys(data.mood_stats || {});
    const moodValues = Object.values(data.mood_stats || {});
    if (moodLabels.length > 0) {
        const ctx2 = document.getElementById('moodChart').getContext('2d');
        moodChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: moodLabels,
                datasets: [{
                    data: moodValues,
                    backgroundColor: ['#22C55E', '#64748B', '#F59E0B', '#EF4444'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } }
            }
        });
    }
    
    // è¶‹åŠ¿å›¾è¡¨
    if (data.daily_trend && data.daily_trend.length > 0) {
        const ctx3 = document.getElementById('trendChart').getContext('2d');
        trendChart = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: data.daily_trend.map(d => d.date.substring(5)),
                datasets: [{
                    label: 'ç£å­¦è®°å½•æ•°',
                    data: data.daily_trend.map(d => d.count),
                    borderColor: '#2563EB',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
}

// åˆ†é¡µæ¸²æŸ“
function renderPagination(selector, data, pageVar, loadFunc) {
    if (data.pages <= 1) {
        $(selector).html('');
        return;
    }
    
    let html = '<ul class="pagination justify-content-center">';
    for (let i = 1; i <= data.pages; i++) {
        const active = i === data.page ? 'active' : '';
        html += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="window['${pageVar}']=${i};${loadFunc.name}();return false;">${i}</a></li>`;
    }
    html += '</ul>';
    $(selector).html(html);
}

// å¿«é€Ÿè®°å½•æ—¥å¿—
function openQuickLog(studentId, studentName) {
    $('#quickLogStudentId').val(studentId);
    $('#quickLogStudentName').text(studentName);
    $('#quickLogForm')[0].reset();
    $('#quickLogForm label.btn').removeClass('btn-primary').addClass('btn-outline-secondary');
    new bootstrap.Modal('#quickLogModal').show();
}

function submitQuickLog() {
    const formData = new FormData($('#quickLogForm')[0]);
    $.post('{{ url_for("supervision.quick_log") }}', Object.fromEntries(formData), function(res) {
        if (res.success) {
            bootstrap.Modal.getInstance('#quickLogModal').hide();
            loadStudents();
            alert('è®°å½•æˆåŠŸï¼');
        } else {
            alert(res.message);
        }
    });
}

// æ‰¹é‡åˆ›å»ºè®¡åˆ’
function loadBatchStudentList() {
    $.get('{{ url_for("supervision.manage_students") }}', { filter: 'all', page: 1 }, function(data) {
        let html = '';
        data.items.forEach(function(s) {
            html += `
                <div class="form-check">
                    <input class="form-check-input batch-student-check" type="checkbox" name="student_ids" value="${s.id}" id="batch-${s.id}">
                    <label class="form-check-label" for="batch-${s.id}">${s.name} ${s.current_plan ? '(æœ‰è®¡åˆ’)' : ''}</label>
                </div>
            `;
        });
        $('#batchStudentList').html(html);
        
        $('.batch-student-check').change(function() {
            $('#selectedStudentCount').text($('.batch-student-check:checked').length);
        });
    });
}

function submitBatchPlan() {
    const templateId = $('#batchPlanForm select[name="template_id"]').val();
    const studentIds = $('.batch-student-check:checked').map(function() { return $(this).val(); }).get();
    
    if (!templateId) {
        alert('è¯·é€‰æ‹©æ¨¡æ¿');
        return;
    }
    if (studentIds.length === 0) {
        alert('è¯·é€‰æ‹©å­¦å‘˜');
        return;
    }
    
    $.post('{{ url_for("supervision.batch_create_plan") }}', {
        template_id: templateId,
        'student_ids': studentIds
    }, function(res) {
        if (res.success) {
            bootstrap.Modal.getInstance('#batchPlanModal').hide();
            alert(res.message);
            loadPlans();
        } else {
            alert(res.message);
        }
    });
}

// åˆ†é…å­¦å‘˜
function loadAssignStudentList() {
    $.get('{{ url_for("supervision.manage_students") }}', { filter: 'all', page: 1 }, function(data) {
        let html = '';
        data.items.forEach(function(s) {
            html += `
                <div class="form-check">
                    <input class="form-check-input assign-student-check" type="checkbox" name="student_ids" value="${s.id}" id="assign-${s.id}">
                    <label class="form-check-label" for="assign-${s.id}">${s.name}</label>
                </div>
            `;
        });
        $('#assignStudentList').html(html);
        
        $('.assign-student-check').change(function() {
            $('#assignStudentCount').text($('.assign-student-check:checked').length);
        });
    });
}

function submitAssign() {
    const supervisorId = $('#assignForm select[name="supervisor_id"]').val();
    const studentIds = $('.assign-student-check:checked').map(function() { return $(this).val(); }).get();
    
    if (!supervisorId) {
        alert('è¯·é€‰æ‹©ç£å­¦è€å¸ˆ');
        return;
    }
    if (studentIds.length === 0) {
        alert('è¯·é€‰æ‹©å­¦å‘˜');
        return;
    }
    
    $.post('{{ url_for("supervision.assign_students") }}', {
        supervisor_id: supervisorId,
        'student_ids': studentIds
    }, function(res) {
        if (res.success) {
            bootstrap.Modal.getInstance('#assignModal').hide();
            alert(res.message);
            loadStudents();
        } else {
            alert(res.message);
        }
    });
}
</script>
{% endblock %}
