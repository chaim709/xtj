{% extends "admin/base.html" %}

{% block title %}{{ workbook.name }} - 错题收集系统{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">{{ workbook.name }}</h1>
    <div>
        <a href="{{ url_for('admin.edit_workbook', id=workbook.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> 编辑
        </a>
        {% if workbook.total_questions > 0 %}
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-file-pdf"></i> 生成PDF
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li class="dropdown-header">文字题模式</li>
                <li>
                    <form action="{{ url_for('admin.generate_workbook', id=workbook.id) }}" method="POST">
                        <input type="hidden" name="embed_mode" value="standard">
                        <button type="submit" class="dropdown-item">
                            <i class="bi bi-file-text me-2"></i>标准模式
                            <small class="text-muted d-block">每页一个二维码（页眉右上角）</small>
                        </button>
                    </form>
                </li>
                <li>
                    <form action="{{ url_for('admin.generate_workbook', id=workbook.id) }}" method="POST">
                        <input type="hidden" name="embed_mode" value="by_category">
                        <button type="submit" class="dropdown-item">
                            <i class="bi bi-grid-3x3 me-2"></i>按分类模式
                            <small class="text-muted d-block">每个板块一个二维码（推荐）</small>
                        </button>
                    </form>
                </li>
                <li>
                    <form action="{{ url_for('admin.generate_workbook', id=workbook.id) }}" method="POST">
                        <input type="hidden" name="embed_mode" value="single_qr">
                        <button type="submit" class="dropdown-item">
                            <i class="bi bi-qr-code me-2"></i>单二维码模式
                            <small class="text-muted d-block">整本题册一个二维码（封面）</small>
                        </button>
                    </form>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li class="dropdown-header">原版增强模式（保留原排版）</li>
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#enhancePdfModal">
                        <i class="bi bi-magic me-2"></i>增强原版文件
                        <small class="text-muted d-block">在原PDF/Word上添加封面和二维码</small>
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li class="dropdown-header">图片题模式</li>
                <li>
                    <form action="{{ url_for('admin.generate_workbook', id=workbook.id) }}" method="POST">
                        <input type="hidden" name="embed_mode" value="fullpage">
                        <button type="submit" class="dropdown-item">
                            <i class="bi bi-image me-2"></i>整页图片模式
                            <small class="text-muted d-block">嵌入原PDF整页（图形推理专用）</small>
                        </button>
                    </form>
                </li>
                <li>
                    <form action="{{ url_for('admin.generate_workbook', id=workbook.id) }}" method="POST">
                        <input type="hidden" name="embed_mode" value="cropped">
                        <button type="submit" class="dropdown-item">
                            <i class="bi bi-crop me-2"></i>裁剪图片模式
                            <small class="text-muted d-block">智能裁剪每道题的图片</small>
                        </button>
                    </form>
                </li>
            </ul>
        </div>
        {% endif %}
        {% if workbook.pdf_path %}
        <a href="{{ url_for('admin.download_workbook', id=workbook.id) }}" class="btn btn-success">
            <i class="bi bi-download"></i> 下载PDF
        </a>
        {% endif %}
    </div>
</div>

<!-- 信息卡片 -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ workbook.total_questions }}</div>
            <div class="stat-label">题目数量</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ workbook.total_pages }}</div>
            <div class="stat-label">页数</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ workbook.questions_per_page }}</div>
            <div class="stat-label">每页题数</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value">
                {% if workbook.pdf_path %}
                <i class="bi bi-check-circle text-success"></i>
                {% else %}
                <i class="bi bi-x-circle text-muted"></i>
                {% endif %}
            </div>
            <div class="stat-label">PDF状态</div>
        </div>
    </div>
</div>

<!-- 题目列表 -->
<div class="card">
    <div class="card-header">
        题目列表
    </div>
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th width="60">序号</th>
                    <th>题干</th>
                    <th width="100">分类</th>
                    <th width="80">答案</th>
                    <th width="80">页码</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td><strong>{{ item.order }}</strong></td>
                    <td>{{ item.question.stem[:60] }}{% if item.question.stem|length > 60 %}...{% endif %}</td>
                    <td><span class="badge badge-category">{{ item.question.category or '未分类' }}</span></td>
                    <td><strong>{{ item.question.answer or '-' }}</strong></td>
                    <td>{{ item.page_num or '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-5 text-muted">
                        暂无题目，请先添加题目
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 增强PDF模态框 -->
<div class="modal fade" id="enhancePdfModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('admin.generate_workbook', id=workbook.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-plus me-2"></i>增强原版文件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="embed_mode" id="enhanceMode" value="enhance_single">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">选择文件来源</label>
                        <ul class="nav nav-tabs" id="fileSourceTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button">
                                    <i class="bi bi-cloud-upload me-1"></i>上传文件
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="path-tab" data-bs-toggle="tab" data-bs-target="#path-pane" type="button">
                                    <i class="bi bi-folder me-1"></i>输入路径
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content border border-top-0 rounded-bottom p-3">
                            <div class="tab-pane fade show active" id="upload-pane" role="tabpanel">
                                <div class="upload-area border-2 border-dashed rounded p-4 text-center" id="dropZone"
                                     style="border-color: #dee2e6; transition: all 0.3s;">
                                    <i class="bi bi-cloud-arrow-up fs-1 text-primary mb-2 d-block"></i>
                                    <p class="mb-2">拖拽文件到此处，或点击选择</p>
                                    <input type="file" class="form-control" name="source_file" id="sourceFileUpload"
                                           accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('sourceFileUpload').click()">
                                        <i class="bi bi-folder2-open me-1"></i>选择文件
                                    </button>
                                    <div id="filePreview" class="mt-3" style="display: none;">
                                        <div class="alert alert-success py-2 mb-0">
                                            <i class="bi bi-file-earmark-check me-2"></i>
                                            <span id="fileName"></span>
                                            <button type="button" class="btn-close btn-sm float-end" onclick="clearFile()"></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text mt-2">支持 PDF、Word（.docx/.doc）格式，最大 50MB</div>
                            </div>
                            <div class="tab-pane fade" id="path-pane" role="tabpanel">
                                <input type="text" class="form-control" name="source_pdf" id="sourceFile"
                                       placeholder="输入PDF或Word文件的完整路径">
                                <div class="form-text">输入服务器上已有文件的完整路径</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">二维码模式</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="form-check card p-3 h-100">
                                    <input class="form-check-input" type="radio" name="qr_mode_radio" id="qrSingle" value="enhance_single" checked>
                                    <label class="form-check-label" for="qrSingle">
                                        <strong><i class="bi bi-qr-code me-1"></i>单二维码</strong>
                                        <small class="text-muted d-block">封面一个二维码，覆盖全部题目</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check card p-3 h-100">
                                    <input class="form-check-input" type="radio" name="qr_mode_radio" id="qrStandard" value="enhance_standard">
                                    <label class="form-check-label" for="qrStandard">
                                        <strong><i class="bi bi-grid me-1"></i>标准模式</strong>
                                        <small class="text-muted d-block">每页右上角一个小二维码</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check card p-3 h-100">
                                    <input class="form-check-input" type="radio" name="qr_mode_radio" id="qrCategory" value="enhance_category">
                                    <label class="form-check-label" for="qrCategory">
                                        <strong><i class="bi bi-grid-3x3 me-1"></i>分类模式</strong>
                                        <small class="text-muted d-block">每个板块一个二维码页</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="categoryRangesDiv" style="display: none;">
                        <label class="form-label fw-bold">分类页码范围（JSON格式）</label>
                        <textarea class="form-control" name="category_ranges" rows="4" 
                                  placeholder='{"片段阅读": [1, 15], "语句表达": [16, 25], "选词填空": [26, 35]}'></textarea>
                        <div class="form-text">格式：{"分类名": [起始页, 结束页], ...}</div>
                    </div>
                    
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-lightbulb me-2"></i>
                        <span id="modeDescription">将在原文件前添加封面页（含机构信息和二维码），保留原始排版</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-magic me-1"></i>生成增强版PDF</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 二维码模式切换
document.querySelectorAll('input[name="qr_mode_radio"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        document.getElementById('enhanceMode').value = this.value;
        
        var categoryDiv = document.getElementById('categoryRangesDiv');
        var desc = document.getElementById('modeDescription');
        
        if (this.value === 'enhance_single') {
            categoryDiv.style.display = 'none';
            desc.textContent = '将在原文件前添加封面页（含机构信息和二维码），保留原始排版';
        } else if (this.value === 'enhance_standard') {
            categoryDiv.style.display = 'none';
            desc.textContent = '将在原文件每页右上角添加小二维码水印，方便按页提交错题';
        } else if (this.value === 'enhance_category') {
            categoryDiv.style.display = 'block';
            desc.textContent = '将在每个分类开始前插入二维码页，适合按板块练习';
        }
    });
});

// 文件上传处理
var dropZone = document.getElementById('dropZone');
var fileInput = document.getElementById('sourceFileUpload');
var filePreview = document.getElementById('filePreview');
var fileName = document.getElementById('fileName');

// 拖拽效果
dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.borderColor = '#0d6efd';
    this.style.backgroundColor = '#f8f9ff';
});

dropZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.style.borderColor = '#dee2e6';
    this.style.backgroundColor = '';
});

dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderColor = '#dee2e6';
    this.style.backgroundColor = '';
    
    var files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        showFilePreview(files[0]);
    }
});

// 文件选择
fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        showFilePreview(this.files[0]);
    }
});

function showFilePreview(file) {
    var ext = file.name.split('.').pop().toLowerCase();
    if (['pdf', 'doc', 'docx'].indexOf(ext) === -1) {
        alert('仅支持 PDF、DOC、DOCX 格式的文件');
        return;
    }
    
    var size = (file.size / 1024 / 1024).toFixed(2);
    fileName.textContent = file.name + ' (' + size + ' MB)';
    filePreview.style.display = 'block';
}

function clearFile() {
    fileInput.value = '';
    filePreview.style.display = 'none';
}
</script>
{% endblock %}
